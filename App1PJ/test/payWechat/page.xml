<page>
  <controls count="3">
    <control type="DivRoot" pathname="/divRoot">
      <backgroundColor>ffffff</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <height>819</height>
      <left>0</left>
      <onControlLoad>g5.onDeviceReady = function () {
    //alert("success cordova");
    //g5.log("cordova initialized succ.");
}
document.addEventListener("deviceready", g5.onDeviceReady, false);

//微信支付接口返回：
//0成功
//-1微信接口故障
//-2用户取消支付
//-3支付过程30秒超时
g5.tamPlugin = { 
    payWechat: function (prepayId, nonceStr, successCallback, errorCallback) {
        if (isIOS) {
            cordova.exec(
                successCallback, // success callback function 
                errorCallback, // error callback function 
                "TamPlugin", // mapped to our native Java class called "CalendarPlugin" 
                "payWechat", // with this action name 
                [prepayId, nonceStr]
            );  
        } else {
            cordova.exec(
                successCallback, // success callback function 
                errorCallback, // error callback function 
                "TamPlugin", // mapped to our native Java class called "CalendarPlugin" 
                "payWechat", // with this action name 
                [{                  // and this array of custom arguments to create our entry 
                    "prepayId": prepayId 
                }] 
            );
        }  
    },
    getVersion: function() {
        cordova.exec(
            function (version) {
                g5.version = version;
                g5.onVersionReady();
            },
            function (msg) {
                g5.onVersionReady();
            },
            "TamPlugin", "getVersion", [{ "a": "" }] 
        );  
    }
}
 

</onControlLoad>
      <onPageCreate>var isIOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
var oHead = document.getElementsByTagName("HEAD").item(0); 
var oScript
if (isIOS) {
    oScript = document.createElement("script"); 
    oScript.type = "text/javascript"; 
    oScript.src="cordova4/cordova.js"; 
    oHead.appendChild( oScript); 
    oScript = document.createElement("script"); 
    oScript.type = "text/javascript"; 
    oScript.src="cordova4/cordova_plugins.js"; 
    oHead.appendChild(oScript); 
} else {
    oScript = document.createElement("script"); 
    oScript.type = "text/javascript"; 
    oScript.src="cordova5/cordova.js"; 
    oHead.appendChild( oScript); 
    oScript = document.createElement("script"); 
    oScript.type = "text/javascript"; 
    oScript.src="cordova5/cordova_plugins.js"; 
    oHead.appendChild(oScript); 
}
</onPageCreate>
      <top>0</top>
      <width>888</width>
    </control>
    <control type="Panel" pathname="/divRoot/panel1">
      <backgroundSkin>button1</backgroundSkin>
      <cursor>pointer</cursor>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FFFFFF</fontColor>
      <height>48</height>
      <heightRatio>0.0586080586080586</heightRatio>
      <left>41</left>
      <leftRatio>0.0461711711711712</leftRatio>
      <onClick>payWechat();</onClick>
      <sizeRatio>0.101910828025478</sizeRatio>
      <text>微信支付测试</text>
      <top>57</top>
      <topRatio>0.0695970695970696</topRatio>
      <width>471</width>
      <widthRatio>0.530405405405405</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel2">
      <backgroundSkin>line3</backgroundSkin>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <hAlign>left</hAlign>
      <height>466</height>
      <heightRatio>0.568986568986569</heightRatio>
      <left>45</left>
      <leftRatio>0.0511727078891258</leftRatio>
      <sizeRatio>1.1256038647343</sizeRatio>
      <text>.</text>
      <top>138</top>
      <topRatio>0.168498168498169</topRatio>
      <width>784</width>
      <widthRatio>0.88272921108742</widthRatio>
    </control>
  </controls>
  <taskSet count="1">
    <taskSetItem name="payWechat">
      <script1>//微信生成预处理订单
eio.appendString8(eb.getCookie("pjToken"));</script1>
      <script2><![CDATA[var payMoney = 1; //支付金额，分为单位

var token = eio.readString8();
//var payIndex = eio.readInt32();
var sql,sqlResult;

sql = "exec getUserInfoBySession '" + db.encode(token) + "'";
sqlResult = db.executeQuery("PJ", sql);
if (sqlResult == null) {
    eio.appendString8("F");
    es.logWarning("数据库执行错误, sql=" + sql);
    return;
}
db.read(sqlResult);
if (db.getString(sqlResult, "sessionId").length < 5) {
    eio.appendString8("F");
    eio.appendString8("token失效");
    es.logWarning("用户token失效, sql=" + sql);
    return;
} 
var userId = db.getString(sqlResult, "id");
if (userId.length<=0) {
    eio.appendString8("F");
    eio.appendString8("会话丢失，请稍后再试");
    return;
}
//产生支付订单
sql = "exec createPay " + userId + ",'微信支付'," + "0.01, 0.02";
sqlResult = db.executeQuery("PJ", sql); 
if (sqlResult == null) {
    eio.appendString8("F");
    eio.appendString8("系统繁忙请稍后再试");
    return;
}
db.read(sqlResult);
var localTicket = db.getString(sqlResult, "ticket");

var data = "";
var sign = "";
var randString = "A" + (new Date()).getTime();
randString = es.getMd5(randString).toUpperCase();
//计算sign
sign += "appid=wx9b5794aacbbdf257";
sign += "&amp;attach=充值";
sign += "&amp;body=1陪驾充值";
sign += "&amp;mch_id=1264325101";
sign += "&amp;nonce_str=" + randString;
sign += "&amp;notify_url=http://m.1peijia.com:88/eengine/ee.aspx";
sign += "&amp;out_trade_no=" + localTicket;
sign += "&amp;spbill_create_ip=127.0.0.1";
sign += "&amp;total_fee=" + payMoney;
sign += "&amp;trade_type=APP";
sign += "&amp;key=YIpeijia123456789012345678901234";
sign = es.getMd5(sign).toUpperCase();
//产生递交数据
data =
    "<xml>\n" + 
    "   <appid>wx9b5794aacbbdf257</appid>\n" + //不解释
    "   <attach>充值</attach>\n" + //附加数据，在查询API和支付通知中原样返回，该字段主要用于商户携带订单的自定义数据
    "   <body>1陪驾充值</body>\n" + //商品或支付单简要描述
    "   <mch_id>1264325101</mch_id>\n" + //微信支付分配的商户号
    "   <nonce_str>" + randString + "</nonce_str>\n" + //随机字符串，不长于32位
    "   <notify_url>http://m.1peijia.com:88/eengine/ee.aspx</notify_url>\n" + //接收微信支付异步通知回调地址，通知url必须为直接可访问的url，不能携带参数。
    "   <out_trade_no>" + localTicket + "</out_trade_no>\n" + //商户系统内部的订单号,32个字符内、可包含字母
    "   <spbill_create_ip>127.0.0.1</spbill_create_ip>\n" + //用户端实际ip
    "   <total_fee>" + payMoney + "</total_fee>\n" + //订单总金额，单位（分）
    "   <trade_type>APP</trade_type>\n" + //支付类型
    "   <sign>" + sign + "</sign>\n" +
    "</xml>\n";
//post
var result = es.post("https://api.mch.weixin.qq.com/pay/unifiedorder", data);
/* 返回消息
<xml><return_code><![CDATA[SUCCESS]]]]><![CDATA[></return_code>
<return_msg><![CDATA[OK]]]]><![CDATA[></return_msg>
<appid><![CDATA[wx9b5794aacbbdf257]]]]><![CDATA[></appid>
<mch_id><![CDATA[1264325101]]]]><![CDATA[></mch_id>
<nonce_str><![CDATA[heGKmfwAQ2zSjfAI]]]]><![CDATA[></nonce_str>
<sign><![CDATA[48BB46F9CCF2901D97F884EB44A7C5DF]]]]><![CDATA[></sign>
<result_code><![CDATA[SUCCESS]]]]><![CDATA[></result_code>
<prepay_id><![CDATA[wx20160520184034d34c9c543c0304138885]]]]><![CDATA[></prepay_id>
<trade_type><![CDATA[APP]]]]><![CDATA[></trade_type>
</xml>
*/
if (result.indexOf("<return_code><![CDATA[SUCCESS]]]]><![CDATA[>")<0) {
    eio.appendString8("F");
    eio.appendString16("微信支付接口暂时无法使用，请稍后再试");
    return;
}
//从返回值中提取prepay_id
var r = result.indexOf("<prepay_id><![CDATA[");
if (r<0) {
    eio.appendString8("F");
    eio.appendString16("微信支付接口暂时无法使用，请稍后再试");
    return;
}
r += "<prepay_id><![CDATA[".length;
var r1 = result.indexOf("]", r);
if (r1<0) {
    eio.appendString8("F");
    eio.appendString16("微信支付接口暂时无法使用，请稍后再试");
    return;
} 
var prepayId = result.substring(r, r1);
eio.appendString8("T");
eio.appendString16(prepayId);
eio.appendString16(randString);
]]></script2>
      <script3>var r = eio.readString8();
if (r!="T") {
    alert(eio.readString16());
    return;
}
var prepayId = eio.readString16();
var nonceStr = eio.readString16();
g5.tamPlugin.payWechat(prepayId,nonceStr,
    function() {
        //g5.log("success");
    },
    function(msg) {
        //g5.log("fail:" + msg);
    }
);

</script3>
    </taskSetItem>
  </taskSet>
  <gridLines count="0" />
</page>