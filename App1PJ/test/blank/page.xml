<page>
  <controls count="13">
    <control type="DivRoot" pathname="/divRoot">
      <backgroundColor>FFFFFF</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <height>816</height>
      <left>0</left>
      <onControlLoad>var isIOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);</onControlLoad>
      <pageHead><![CDATA[<meta name="viewport" content="width=device-width, minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">]]></pageHead>
      <top>0</top>
      <width>713</width>
    </control>
    <control type="Panel" pathname="/divRoot/panel1">
      <backgroundColor>47A9F9</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>15</fontSizeAuto>
      <height>64</height>
      <heightRatio>0.0784313725490196</heightRatio>
      <left>-1</left>
      <leftRatio>-0.00102986611740474</leftRatio>
      <sizeRatio>0.065775950668037</sizeRatio>
      <text>兑换优惠卷</text>
      <top>19</top>
      <topRatio>0.0232843137254902</topRatio>
      <width>714</width>
      <widthRatio>1.00205973223481</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel2">
      <dockX>ratio</dockX>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>15</fontSizeAuto>
      <height>63</height>
      <heightRatio>0.984375</heightRatio>
      <left>13</left>
      <leftRatio>0.0182926829268293</leftRatio>
      <sizeRatio>0.63</sizeRatio>
      <text><![CDATA[<]]></text>
      <top>1</top>
      <topRatio>0.015625</topRatio>
      <width>62</width>
      <widthRatio>0.0871080139372822</widthRatio>
    </control>
    <control type="Edit" pathname="/divRoot/edit1">
      <backgroundColor>FFFFFF</backgroundColor>
      <backgroundSkin>edit1</backgroundSkin>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <hAlign>left</hAlign>
      <height>63</height>
      <heightRatio>0.0772058823529412</heightRatio>
      <inputFontSize>18</inputFontSize>
      <inputFontSizeAuto>18</inputFontSizeAuto>
      <left>115</left>
      <leftRatio>0.160659114315139</leftRatio>
      <sizeRatio>0.094311377245509</sizeRatio>
      <top>139</top>
      <topRatio>0.170343137254902</topRatio>
      <width>491</width>
      <widthRatio>0.687950566426365</widthRatio>
    </control>
    <control type="Button" pathname="/divRoot/button1">
      <backgroundColor>47A9F9</backgroundColor>
      <backgroundSkin>button3</backgroundSkin>
      <dockX>ratio</dockX>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>15</fontSizeAuto>
      <height>60</height>
      <heightRatio>0.0735294117647059</heightRatio>
      <left>112</left>
      <leftRatio>0.157569515962925</leftRatio>
      <onClick>getVouchers()</onClick>
      <sizeRatio>0.0890207715133531</sizeRatio>
      <text>兑换</text>
      <top>259</top>
      <topRatio>0.317401960784314</topRatio>
      <width>495</width>
      <widthRatio>0.694129763130793</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43">
      <aniAlpha>whiteAlpha:白色淡出</aniAlpha>
      <backgroundColor>000000</backgroundColor>
      <backgroundImg>dialogMask.png</backgroundImg>
      <backgroundImgMode>stretch</backgroundImgMode>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <height>816</height>
      <heightRatio>1</heightRatio>
      <layerName>m1</layerName>
      <layerVisible>false</layerVisible>
      <left>0</left>
      <sizeRatio>1.14446002805049</sizeRatio>
      <top>0</top>
      <width>713</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel4">
      <backgroundSkin>button3a000</backgroundSkin>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>20</fontSizeAuto>
      <height>441</height>
      <heightRatio>0.540441176470588</heightRatio>
      <left>125</left>
      <leftRatio>0.17531556802244</leftRatio>
      <sizeRatio>0.928421052631579</sizeRatio>
      <top>209</top>
      <topRatio>0.256127450980392</topRatio>
      <width>475</width>
      <widthRatio>0.666199158485273</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel4/panel9">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontBold>true</fontBold>
      <fontSizeAuto>22</fontSizeAuto>
      <height>57</height>
      <heightRatio>0.129251700680272</heightRatio>
      <left>13</left>
      <leftRatio>0.0266272189349112</leftRatio>
      <sizeRatio>0.180379746835443</sizeRatio>
      <text>优惠券详情</text>
      <top>60</top>
      <topRatio>0.136054421768707</topRatio>
      <width>444</width>
      <widthRatio>0.93491124260355</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel4/panel47">
      <backgroundSkin>button3000</backgroundSkin>
      <cursor>pointer</cursor>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>25</fontSizeAuto>
      <height>54</height>
      <heightRatio>0.122448979591837</heightRatio>
      <left>102</left>
      <leftRatio>0.214736842105263</leftRatio>
      <onClick>//ee.hidenAllLayer(ee.getControl("panel43"));    
ee.setVisible(ee.getControl("panel43"), false); </onClick>
      <sizeRatio>0.207692307692308</sizeRatio>
      <text>取消</text>
      <top>343</top>
      <topRatio>0.777777777777778</topRatio>
      <width>260</width>
      <widthRatio>0.547368421052632</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel4/panel13">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontBold>true</fontBold>
      <fontColor>48A1DD</fontColor>
      <fontSizeAuto>30</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>47</height>
      <heightRatio>0.106575963718821</heightRatio>
      <left>21</left>
      <leftRatio>0.0443786982248521</leftRatio>
      <sizeRatio>0.309210526315789</sizeRatio>
      <text>使用代金券</text>
      <top>10</top>
      <topRatio>0.0226757369614512</topRatio>
      <width>214</width>
      <widthRatio>0.449704142011834</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel4/panel14">
      <backgroundColor>48A1DD</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>2</height>
      <heightRatio>0.0050125313283208</heightRatio>
      <left>19</left>
      <leftRatio>0.040650406504065</leftRatio>
      <sizeRatio>0.0044543429844098</sizeRatio>
      <top>52</top>
      <topRatio>0.117794486215539</topRatio>
      <width>433</width>
      <widthRatio>0.91260162601626</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel4/panel50">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>404040</fontColor>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>21</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>154</height>
      <heightRatio>0.349206349206349</heightRatio>
      <left>60</left>
      <leftRatio>0.126315789473684</leftRatio>
      <sizeRatio>0.391857506361323</sizeRatio>
      <text>详情：</text>
      <top>108</top>
      <topRatio>0.244897959183673</topRatio>
      <vAlign>top</vAlign>
      <width>393</width>
      <widthRatio>0.827368421052632</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel4/panel16">
      <backgroundSkin>button3</backgroundSkin>
      <cursor>pointer</cursor>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>25</fontSizeAuto>
      <height>54</height>
      <heightRatio>0.122448979591837</heightRatio>
      <left>102</left>
      <leftRatio>0.214736842105263</leftRatio>
      <sizeRatio>0.207692307692308</sizeRatio>
      <text>确认使用</text>
      <top>279</top>
      <topRatio>0.63265306122449</topRatio>
      <width>260</width>
      <widthRatio>0.547368421052632</widthRatio>
    </control>
  </controls>
  <taskSet count="1">
    <taskSetItem name="getVouchers">
      <script1>var result=ee.getEditText(ee.getControl("edit1"));
result = result.replace(/\s+/g,"");  
if(result==''){
    alert('代金卷号不能为空！');    
    return false;
}
eio.appendString8(result);        
eio.appendString8(eb.getCookie("pjToken")); 
</script1>
      <script2><![CDATA[var serialNumber = eio.readString8();
var token = eio.readString8();
var sql,sqlResult;   

sql = "exec getUserInfoBySession '" + db.encode(token) + "'";
sqlResult = db.executeQuery("PJ", sql); 
//es.logWarning(sql);
if (sqlResult == null) {
    eio.appendString8("F");
    es.logWarning("数据库执行错误, sql=" + sql);
    return;
}
db.read(sqlResult);
if (db.getString(sqlResult, "sessionId").length < 5) {
    eio.appendString8("F");
    eio.appendString8("token失效");
    es.logWarning("用户token失效, sql=" + sql);
    return;
} 
var userId = db.getString(sqlResult, "id"); 

/*sql = "exec getCashTicket '" + db.encode(serialNumber) + "','"+db.encode(userId)+"'";
es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql);  
db.read(sqlResult);
es.logWarning(sql);
var errorCode = db.getInt32(sqlResult, "errorCode");
es.logWarning(errorCode);
if (errorCode!=0) {
    eio.appendString8("F");
    eio.appendString8(db.getString(sqlResult, "errorString"));
    return;
}*/
sql="select count(*) as c from cashTicket where serialNumber='"+db.encode(serialNumber)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
//es.logWarning(sql);
db.read(sqlResult);
var count=db.getInt32(sqlResult,"c");
if(count<1){
   eio.appendString8("F"); 
   eio.appendString8("代金券错误");
   return;
}

/*
sql="select count(*) as c from cashTicket where userId='"+db.encode(userId)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
es.logWarning(sql);
db.read(sqlResult);
var count=db.getInt32(sqlResult,"c");
if(count>0){
   eio.appendString8("F"); 
   eio.appendString8("您已经使用过代金券");
   return;
}
*/

sql="select * from cashTicket where serialNumber='"+db.encode(serialNumber)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
//es.logWarning(sql);
db.read(sqlResult);
var displayName = db.getString(sqlResult, "displayName");
var pay = db.getString(sqlResult, "pay");
var payFree = db.getString(sqlResult, "payFree");
var regDatetime = db.getString(sqlResult, "regDatetime");
var used = db.getString(sqlResult, "used");
var cashName = db.getString(sqlResult,"name");
 
if (cashName == "南航积分201701"){
 
    if(used=="T"){
       eio.appendString8("F"); 
       eio.appendString8("该代金券已被使用");
       return;
    }
    if(used=="D"){
       eio.appendString8("F"); 
       eio.appendString8("您的优惠券已过期");
       return;
    }
          

}else {
    sql="select count(*) as c from cashTicket where userId='"+db.encode(userId)+"' and displayName = '"+ displayName+"'"; 
    sqlResult = db.executeQuery("PJ", sql);  
   // es.logWarning(sql);
    db.read(sqlResult);
    var count=db.getInt32(sqlResult,"c");
    if(count>0){
       eio.appendString8("F"); 
       eio.appendString8("您已经使用过该类代金券");
       return;
    }
     
    if(used=="T"){
       eio.appendString8("F"); 
       eio.appendString8("该代金券已被使用");
       return;
    }
    
    if(used=="D"){
       eio.appendString8("F"); 
       eio.appendString8("您的优惠券已过期");
       return;
    }   
}
eio.appendString8("T"); 
eio.appendString8(displayName);
eio.appendString8(pay);
eio.appendString8(payFree);
eio.appendString8(regDatetime);
eio.appendString8(used);

]]></script2>
      <script3><![CDATA[var result = eio.readString8();   
if (result=="F") {
    alert("优惠券使用失败：" + eio.readString8());
    return;
} 
var displayName =eio.readString8();
var pay =eio.readString8();
var payFree =eio.readString8();
var regDatetime =eio.readString8();
var used =eio.readString8();
var index = regDatetime.indexOf(" "); 
regDatetime = regDatetime.substr(0,index); 



if(used=="T"){
    alert("该优惠券已过期或已被使用");
    return;
} 
else {
    used="可使用";
}
var text="优惠券名称："+displayName+"<br />包含金额："+pay.substring(0,pay.indexOf(".") + 3)+"<br />包含积分："+payFree.substring(0,payFree.indexOf(".") + 3)+"<br />使用状态："+used;
ee.setText(ee.getControl("panel50"),text); 
ee.showAni(ee.getControl("panel43"));        
]]></script3>
    </taskSetItem>
  </taskSet>
  <gridLines count="0" />
</page>