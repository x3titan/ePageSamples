<page>
  <controls count="8">
    <control type="DivRoot" pathname="/divRoot">
      <autoScroll>true</autoScroll>
      <backgroundColor>ffffff</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <height>816</height>
      <left>0</left>
      <onControlLoad>setTimeout(function(){
    ee.autoResize = false;
},1000);

ee.setVisible(ee.getControl("panel3"),true); //获取验证码层  显示      

var url = window.location.search;
var index = url.indexOf("&amp;");
if (index != -1){
   var arr = url.split("&amp;");
   console.log(arr);
   g5.schoolId = arr[1]; 
   getSchoolInfo(); //获取驾校信息
}






</onControlLoad>
      <pageHead><![CDATA[<meta name="viewport" content="width=device-width, minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">]]></pageHead>
      <scrollPosY>211</scrollPosY>
      <top>0</top>
      <width>1045</width>
    </control>
    <control type="Panel" pathname="/divRoot/panel1">
      <backgroundImg>报名3.png</backgroundImg>
      <backgroundImgMode>stretch</backgroundImgMode>
      <dockX>fill</dockX>
      <dockY>ratio</dockY>
      <height>1030</height>
      <heightRatio>1.26225490196078</heightRatio>
      <left>0</left>
      <leftRatio>-0.00230414746543779</leftRatio>
      <sizeRatio>2.37327188940092</sizeRatio>
      <top>0</top>
      <width>1045</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Edit" pathname="/divRoot/panel1/edit1">
      <backgroundSkin>empty</backgroundSkin>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>9E9E9E</fontColor>
      <fontFamily>Tahoma</fontFamily>
      <fontSizeAuto>22</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>61</height>
      <heightRatio>0.0592233009708738</heightRatio>
      <inputFont>Arial</inputFont>
      <inputFontSizeAuto>20</inputFontSizeAuto>
      <left>92</left>
      <leftRatio>0.0876404494382022</leftRatio>
      <sizeRatio>0.165311653116531</sizeRatio>
      <text>手机号</text>
      <top>387</top>
      <topRatio>0.375728155339806</topRatio>
      <width>867</width>
      <widthRatio>0.829213483146067</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel2">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>139</height>
      <heightRatio>0.13495145631068</heightRatio>
      <left>99</left>
      <leftRatio>0.0943820224719101</leftRatio>
      <onClick>window.location.href = ee.pageRoot + "/weChatPlatform/downLoadApp";</onClick>
      <sizeRatio>0.412462908011869</sizeRatio>
      <top>813</top>
      <topRatio>0.789320388349515</topRatio>
      <width>791</width>
      <widthRatio>0.757303370786517</widthRatio>
    </control>
    <control type="Edit" pathname="/divRoot/panel1/edit2">
      <backgroundSkin>empty</backgroundSkin>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>9E9E9E</fontColor>
      <fontFamily>Tahoma</fontFamily>
      <fontSizeAuto>22</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>61</height>
      <heightRatio>0.0592233009708738</heightRatio>
      <inputFont>Arial</inputFont>
      <inputFontSizeAuto>20</inputFontSizeAuto>
      <left>92</left>
      <leftRatio>0.0876404494382022</leftRatio>
      <sizeRatio>0.240157480314961</sizeRatio>
      <text>验证码</text>
      <top>461</top>
      <topRatio>0.447572815533981</topRatio>
      <width>596</width>
      <widthRatio>0.570786516853933</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>60</height>
      <heightRatio>0.058252427184466</heightRatio>
      <layerName>获取验证码</layerName>
      <layerVisible>false</layerVisible>
      <left>730</left>
      <leftRatio>0.698876404494382</leftRatio>
      <onClick>var flag=1;
var wait=60;                               
    function time(o) { 
       var mobile = ee.getEditText(ee.getControl("edit1"));
            //手机号码检测
           if (mobile.length!=11) {
               alert("对不起，您输入的不是一个有效的手机号码");
               return;
           }
           if (!(/^\d+$/.test(mobile))) {
               alert("对不起，您输入的不是一个有效的手机号码");
               return;
        }   
        if (wait == 0) {  
            ee.setVisible(ee.getControl("panel3"),true); //获取验证码层
            ee.setVisible(ee.getControl("panel4"),false);  //读秒层  
            /*           
            ee.getControl(o).removeAttribute("disabled");           
            ee.setText(ee.getControl(o),"获取验证码");  
            ee.setTextColor(ee.getControl(o),"rgb(71, 169, 249)") 
            */
            wait = 60;  
            flag=1;
        } else {    
            if(flag==1){
               getSmsCode();; 
               console.log("发送短信");
            }    
            flag=0; 
            ee.setVisible(ee.getControl("panel3"),false); //获取验证码层
            ee.setVisible(ee.getControl("panel4"),true);  //读秒层
            /*
            ee.getControl(o).setAttribute("disabled", true);  
            ee.setText(ee.getControl(o),"重新发送(" + wait + ")");   
            ee.setTextColor(ee.getControl(o),"rgb(181, 181, 181)")   
            */
            ee.setText(ee.getControl("panel4"),wait+"s");
            wait--;  
            setTimeout(function() {  
                time(o)  
            },  
            1000)  
        }  
    }  

time(this);</onClick>
      <sizeRatio>0.6</sizeRatio>
      <top>460</top>
      <topRatio>0.446601941747573</topRatio>
      <width>235</width>
      <widthRatio>0.224719101123595</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel4">
      <backgroundColor>FF8639</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontBold>true</fontBold>
      <fontColor>FFFFFF</fontColor>
      <fontFamily>Arial</fontFamily>
      <fontSizeAuto>18</fontSizeAuto>
      <height>44</height>
      <heightRatio>0.0427184466019417</heightRatio>
      <layerName>读秒</layerName>
      <left>742</left>
      <leftRatio>0.709677419354839</leftRatio>
      <sizeRatio>0.517647058823529</sizeRatio>
      <text>.</text>
      <top>468</top>
      <topRatio>0.454368932038835</topRatio>
      <width>205</width>
      <widthRatio>0.195852534562212</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel5">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>55</height>
      <heightRatio>0.0533980582524272</heightRatio>
      <left>56</left>
      <leftRatio>0.0539325842696629</leftRatio>
      <onClick>checkSmsCode();</onClick>
      <sizeRatio>0.142487046632124</sizeRatio>
      <top>545</top>
      <topRatio>0.529126213592233</topRatio>
      <width>906</width>
      <widthRatio>0.867415730337079</widthRatio>
    </control>
  </controls>
  <taskSet count="4">
    <taskSetItem name="getSmsCode">
      <script1>var mobile = ee.getEditText(ee.getControl("edit1"));
//手机号码检测
if (mobile.length!=11) {
    alert("对不起，您输入的不是一个有效的手机号码");
    return;
}
if (!(/^\d+$/.test(mobile))) {
    alert("对不起，您输入的不是一个有效的手机号码");
    return;
} 

eio.appendString8(mobile); 

</script1>
      <script2><![CDATA[var mobile = eio.readString8();

session.set("codeFlag11",0);//使用于checkSmsCode
while (true) { 
    /*
    var sql = "select * from userInfo where mobile='" + mobile + "' and enabled='T'";
    var sqlResult = db.executeQuery("PJ", sql);  
   
    if (db.read(sqlResult)) {
        eio.appendString8("F");
        var userType = db.getString(sqlResult,"userType");
        if(userType =="教练" || chooseType=="0"){
            eio.appendString8("您输入的手机号码已经被注册使用过，请通过登录页面“忘记密码”功能来登录"); 
        } else if(userType == "学员") {
            eio.appendString8("applyCoaches")
        } else {
            eio.appendString8("判断失败");
        }
        return;
    }
    */
    
    //后台手机号验证
    if (mobile.length!=11) {
        eio.appendString8("F");
        eio.appendString8("手机号非法");
        break;
    }
    if (!(/^1[3|4|5|7|8][0-9]\d{4,8}$/.test(mobile))) {
        eio.appendString8("F");
        eio.appendString8("手机号非法");
        break;
    }
    //产生验证码
    var code = 0;
    var seed = (new Date()).getTime();
    while (code<1000) {
        seed = ( seed * 9301 + 49297 ) % 233280;
        var rand = seed / 233280.0;
        code = Math.floor(rand * 10000);
    }
    //存储验证码和手机号
    session.set("mobileCode", code + "");
    session.set("mobile", mobile);  
    
    //发送验证码
    var sql = "insert into sms (mobile, message) values (" +
        "'" + db.encode(mobile) + "'," +
        "'您的验证码是：" + code + "')";
    if (!db.executeNoneQuery("PJ", sql)) {
        eio.appendString8("F");
        eio.appendString8("系统繁忙请稍后再试");
        break;
    } 
    eio.appendString8("T"); 
    break;
}     

              ]]></script2>
      <script3>if (eio.readString8()!="T") {
    var code = eio.readString8();
    console.log("code="+code);    
    alert("发送验证码失败：" + code);    
    return;
}   

alert("验证码已经以短信的形式发送到您的手机上，请注意查收。验证码是一个4位的数字，请将它填写在下面的栏目中");

</script3>
    </taskSetItem>
    <taskSetItem name="checkSmsCode">
      <script1>var mobileCode = ee.getEditText(ee.getControl("edit2")); 
 
eio.appendString8(mobileCode);  

</script1>
      <script2><![CDATA[var mobileCode = eio.readString8();  

while (true) {
    var mobileCodeS = session.get("mobileCode");
    if (mobileCodeS.length<=0) {      
        eio.appendString8("F");
        eio.appendString8("请点击“获取验证码”，收到短信后填写验证码");
        break;
    } 

    
    if(mobileCodeS!=mobileCode){
        var flag = session.get("codeFlag11"); 
       //  eio.appendString8("flag::"+flag);
        flag = parseInt(flag)+1;
       // flag +=1;  
       //  eio.appendString8("flag++::"+flag);
        session.set("codeFlag11",flag);
        eio.appendString8("F");
        if(flag ==1){
           eio.appendString8("输入的验证码不正确，您还有 2 次机会重新输入验证码");
        }else if(flag ==2){
           eio.appendString8("输入的验证码不正确，您还有 1 次机会重新输入验证码");
        }else if(flag ==3){
            session.set("codeFlag11",0);           
            session.set("mobileCode",""); 
            eio.appendString8("您输入的验证码不正确，请重新获取并输入验证码");
        }
        break;
        
    } 
   
    session.set("codeFlag11",0);
    eio.appendString8("T");
    session.set("mobileCheck", "true"); 
    session.set("mobileCode","");
    break;
} 


]]></script2>
      <script3>
if (eio.readString8()!="T") {
    alert("验证失败：" + eio.readString8());     
    //alert(session.get("userType"))
    ee.setEditText(ee.getControl("Edit2"),"");
    return;
}   
    
creatApplyInfo(); 


 
</script3>
    </taskSetItem>
    <taskSetItem name="creatApplyInfo">
      <script1>/*
    1.判断是否存在该用户， 否，则创建该手机用户
    2.创建申请信息：报名的记录

*/  

eio.appendString8(ee.getEditText(ee.getControl("edit1")));  
eio.appendInt32(g5.schoolId);
eio.appendString8(g5.schoolName); 
eio.appendString8(g5.price2);

console.log("do creatApplyInfo")</script1>
      <script2>var mobile = eio.readString8(); 
var schoolId = eio.readInt32();
var schoolName = eio.readString8(); 
var price2 = eio.readString8();
var applyName = "";
//es.logWarning("mobile="+mobile);
var mobile_session = session.get("mobile");

if (mobile_session !="" &amp;&amp; mobile_session != mobile) mobile = mobile_session;

var sql,sqlResult; 
var getUserId = "";
sql = "select * from userinfo where mobile = '"+ db.encode(mobile) +"'";
sqlResult = db.executeQuery("PJ",sql);
//es.logWarning(sql);
db.read(sqlResult);
var id = db.getString(sqlResult,"id"); 
//es.logWarning("id="+id); 
 
//获取到报名用户的id， 如果手机号为注册则注册后获取id
if (id == ""){
    es.logWarning("kong ")
    sql = "exec createUser '"+db.encode(mobile)+"'";
    var sqlResult1 = db.executeQuery("PJ",sql); 
    db.read(sqlResult1);
    getUserId = db.getString(sqlResult1,"getId");
    es.logWarning("getUserId when is kong:"+getUserId);
    
}else {
    getUserId = id;
    es.logWarning("getUserId="+ getUserId); 
    var idName = db.getString(sqlResult,"idName");
    var nickName = db.getString(sqlResult,"nickName");  
    applyName = nickName;
    if (idName != "") applyName = idName;  
}  



sql="insert into learnDrive(uid,schoolName,applyName,tel,status,price1) values("+getUserId+",'"+schoolName+"','"+applyName+"','"+db.encode(mobile)+"','未付款','"+price2+"')";  
//es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql);  


eio.appendString8("T");
 
</script2>
      <script3>var c = eio.readString8();

if (c != "T"){
    alert("报名出错，请直接联系客服，客服热线：400-026-9090");
    return;
}          

alert("报名申请已提交，请耐心等待客服电话");</script3>
    </taskSetItem>
    <taskSetItem name="getSchoolInfo">
      <script1>//从优惠学车模块链接过来时，获取到URL中的学校Id，根据这个Id 获取其它信息
eio.appendInt32(g5.schoolId);</script1>
      <script2>var id = eio.readInt32();
var sql,sqlResult;
sql = "select * from schoolInfo where id = '"+db.encode(id)+"'";
sqlResult = db.executeQuery("PJ",sql);
db.read(sqlResult);
var schoolName = db.getString(sqlResult,"schoolName");
var tel = db.getString(sqlResult,"tel");
var price1 = db.getString(sqlResult,"price1");
var price2 = db.getString(sqlResult,"price2"); 

eio.appendString8("T");
eio.appendString8(schoolName);
eio.appendString8(tel);
eio.appendString8(price1);
eio.appendString8(price2);</script2>
      <script3>var c = eio.readString8();
if (c != "T"){
    alert("获取驾校信息失败");
    return;
}          
g5.schoolName = eio.readString8();
g5.tel = eio.readString8();
g5.price1 = eio.readString8();
g5.price2 = eio.readString8();    

g5.price1 = parseInt(g5.price1);
g5.price2 = parseInt(g5.price2);
</script3>
    </taskSetItem>
  </taskSet>
  <gridLines count="0" />
</page>