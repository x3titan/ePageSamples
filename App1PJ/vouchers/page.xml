<page>
  <controls count="17">
    <control type="DivRoot" pathname="/divRoot">
      <backgroundColor>ffffff</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <height>799</height>
      <left>0</left>
      <onControlLoad><![CDATA[var isIOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
if (!isIOS) {
    ee.getControl("layoutyitem1").heavy = 0;
}
setTimeout(function(){
    ee.autoResize = false;
},1000); 

ee.setOnClick(ee.getControl("panel2"), function(sender, event){  

   // alert();    
   var text=ee.getEditText(ee.getControl("edit1")) 

   if(text.length <=0){
       alert("代金券号不能为空！"); 
       return;
   }  
   getVouchers();                             
   
});  

ee.setOnClick(ee.getControl("panel16"), function(sender, event) {

    updateVouchers();
});   

ee.setOnClick(ee.getControl("panel47"), function(sender, event) { 

    ee.setVisible(ee.getControl("panel43"), false);
});
]]></onControlLoad>
      <pageHead><![CDATA[<meta name="viewport" content="width=device-width, minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">]]></pageHead>
      <top>0</top>
      <width>1147</width>
    </control>
    <control type="LayoutY" pathname="/divRoot/layouty1">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fieldCount>2</fieldCount>
      <height>88</height>
      <heightRatio>0.10989010989011</heightRatio>
      <left>0</left>
      <sizeRatio>0.149750415973378</sizeRatio>
      <top>0</top>
      <width>1147</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="LayoutYItem" pathname="/divRoot/layouty1/layoutyitem1">
      <backgroundColor>BFCEDF</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <heavy>47</heavy>
      <height>28</height>
      <heightRatio>0.322222222222222</heightRatio>
      <left>0</left>
      <sizeRatio>0.0277511961722488</sizeRatio>
      <top>0</top>
      <width>1147</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="LayoutYItem" pathname="/divRoot/layouty1/layoutyitem2">
      <backgroundColor>47A9F9</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <fontColor>FFFFFF</fontColor>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>15</fontSizeAuto>
      <height>60</height>
      <heightRatio>0.677777777777778</heightRatio>
      <left>0</left>
      <sizeRatio>0.0583732057416268</sizeRatio>
      <text>兑换优惠券</text>
      <top>28</top>
      <topRatio>0.322222222222222</topRatio>
      <width>1147</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/layouty1/layoutyitem2/panel8">
      <backgroundImg>back.png</backgroundImg>
      <backgroundImgMode>fill</backgroundImgMode>
      <cursor>pointer</cursor>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontSizeAuto>30</fontSizeAuto>
      <height>33</height>
      <heightRatio>0.557377049180328</heightRatio>
      <left>31</left>
      <leftRatio>0.0274442538593482</leftRatio>
      <sizeRatio>0.492753623188406</sizeRatio>
      <top>13</top>
      <topRatio>0.213114754098361</topRatio>
      <width>136</width>
      <widthRatio>0.118353344768439</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/layouty1/layoutyitem2/panel10">
      <backgroundSkin>empty</backgroundSkin>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>56</height>
      <heightRatio>0.934426229508197</heightRatio>
      <left>2</left>
      <leftRatio>0.00166389351081531</leftRatio>
      <onClick>window.location.href = ee.pageRoot + "/pay";
</onClick>
      <sizeRatio>0.487179487179487</sizeRatio>
      <top>1</top>
      <topRatio>0.0163934426229508</topRatio>
      <width>223</width>
      <widthRatio>0.194675540765391</widthRatio>
    </control>
    <control type="Edit" pathname="/divRoot/edit1">
      <backgroundSkin>edit1</backgroundSkin>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontFamily>黑体</fontFamily>
      <height>58</height>
      <heightRatio>0.0723039215686275</heightRatio>
      <inputFont>黑体</inputFont>
      <inputFontSize>18</inputFontSize>
      <inputFontSizeAuto>18</inputFontSizeAuto>
      <left>161</left>
      <leftRatio>0.140229885057471</leftRatio>
      <sizeRatio>0.188498402555911</sizeRatio>
      <top>130</top>
      <topRatio>0.162990196078431</topRatio>
      <width>825</width>
      <widthRatio>0.719540229885058</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel2">
      <backgroundSkin>button3</backgroundSkin>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FFFFFF</fontColor>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>20</fontSizeAuto>
      <height>62</height>
      <heightRatio>0.0772058823529412</heightRatio>
      <left>160</left>
      <leftRatio>0.139737991266376</leftRatio>
      <sizeRatio>0.191489361702128</sizeRatio>
      <text>兑 换</text>
      <top>221</top>
      <topRatio>0.276960784313726</topRatio>
      <width>824</width>
      <widthRatio>0.718340611353712</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>25</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>355</height>
      <heightRatio>0.444852941176471</heightRatio>
      <layerName>说明</layerName>
      <layerVisible>false</layerVisible>
      <left>163</left>
      <leftRatio>0.141791044776119</leftRatio>
      <sizeRatio>1.2560553633218</sizeRatio>
      <text>1、每人仅限使用一张代金券。注意：面值200元的代金券可全额覆盖自带车陪驾2小时的费用，如您需要陪练员供车或者延长陪驾时间，需再充值至少100元方可正常下单。

2、本券有效期至2016年9月30日。

3、此次活动最终解释权归1陪驾所有。</text>
      <top>330</top>
      <topRatio>0.412990196078431</topRatio>
      <vAlign>top</vAlign>
      <width>825</width>
      <widthRatio>0.718905472636816</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43">
      <aniAlpha>whiteAlpha:白色淡出</aniAlpha>
      <backgroundColor>000000</backgroundColor>
      <backgroundImg>dialogMask.png</backgroundImg>
      <backgroundImgMode>stretch</backgroundImgMode>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <height>799</height>
      <heightRatio>1</heightRatio>
      <layerName>m1</layerName>
      <layerVisible>false</layerVisible>
      <left>0</left>
      <sizeRatio>0.780861244019139</sizeRatio>
      <top>0</top>
      <width>1147</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3">
      <backgroundSkin>button3a000</backgroundSkin>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>20</fontSizeAuto>
      <height>432</height>
      <heightRatio>0.540903540903541</heightRatio>
      <left>114</left>
      <leftRatio>0.0990990990990991</leftRatio>
      <sizeRatio>0.467299578059072</sizeRatio>
      <top>149</top>
      <topRatio>0.186813186813187</topRatio>
      <width>891</width>
      <widthRatio>0.776412776412776</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel9">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontBold>true</fontBold>
      <fontSizeAuto>22</fontSizeAuto>
      <height>56</height>
      <heightRatio>0.129251700680272</heightRatio>
      <left>24</left>
      <leftRatio>0.0266272189349112</leftRatio>
      <sizeRatio>0.180379746835443</sizeRatio>
      <text>优惠券详情</text>
      <top>59</top>
      <topRatio>0.136054421768707</topRatio>
      <width>833</width>
      <widthRatio>0.93491124260355</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel47">
      <backgroundSkin>button3000</backgroundSkin>
      <cursor>pointer</cursor>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>25</fontSizeAuto>
      <height>53</height>
      <heightRatio>0.121896162528217</heightRatio>
      <left>191</left>
      <leftRatio>0.214814814814815</leftRatio>
      <sizeRatio>0.146341463414634</sizeRatio>
      <text>取消</text>
      <top>336</top>
      <topRatio>0.778781038374718</topRatio>
      <width>487</width>
      <widthRatio>0.546666666666667</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel13">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontBold>true</fontBold>
      <fontColor>48A1DD</fontColor>
      <fontSizeAuto>30</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>46</height>
      <heightRatio>0.106575963718821</heightRatio>
      <left>40</left>
      <leftRatio>0.0443786982248521</leftRatio>
      <sizeRatio>0.309210526315789</sizeRatio>
      <text>使用代金券</text>
      <top>10</top>
      <topRatio>0.0226757369614512</topRatio>
      <width>401</width>
      <widthRatio>0.449704142011834</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel14">
      <backgroundColor>48A1DD</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>2</height>
      <heightRatio>0.0050125313283208</heightRatio>
      <left>36</left>
      <leftRatio>0.040650406504065</leftRatio>
      <sizeRatio>0.0044543429844098</sizeRatio>
      <top>51</top>
      <topRatio>0.117794486215539</topRatio>
      <width>813</width>
      <widthRatio>0.91260162601626</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel50">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>404040</fontColor>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>21</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>151</height>
      <heightRatio>0.349206349206349</heightRatio>
      <left>113</left>
      <leftRatio>0.127218934911243</leftRatio>
      <sizeRatio>0.55</sizeRatio>
      <text>详情：</text>
      <top>106</top>
      <topRatio>0.244897959183673</topRatio>
      <vAlign>top</vAlign>
      <width>738</width>
      <widthRatio>0.828402366863905</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel16">
      <backgroundSkin>button3</backgroundSkin>
      <cursor>pointer</cursor>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>25</fontSizeAuto>
      <height>53</height>
      <heightRatio>0.121896162528217</heightRatio>
      <left>190</left>
      <leftRatio>0.213333333333333</leftRatio>
      <sizeRatio>0.145945945945946</sizeRatio>
      <text>确认使用</text>
      <top>273</top>
      <topRatio>0.632054176072235</topRatio>
      <width>488</width>
      <widthRatio>0.548148148148148</widthRatio>
    </control>
  </controls>
  <taskSet count="2">
    <taskSetItem name="getVouchers">
      <script1>var result=ee.getEditText(ee.getControl("edit1"));
result = result.replace(/\s+/g,"");
eio.appendString8(result);
   
eio.appendString8(eb.getCookie("pjToken"));
</script1>
      <script2><![CDATA[var serialNumber = eio.readString8();
var token = eio.readString8();
var sql,sqlResult;   

sql = "exec getUserInfoBySession '" + db.encode(token) + "'";
sqlResult = db.executeQuery("PJ", sql); 
//es.logWarning(sql);
if (sqlResult == null) {
    eio.appendString8("F");
    es.logWarning("数据库执行错误, sql=" + sql);
    return;
}
db.read(sqlResult);
if (db.getString(sqlResult, "sessionId").length < 5) {
    eio.appendString8("F");
    eio.appendString8("token失效");
    es.logWarning("用户token失效, sql=" + sql);
    return;
} 
var userId = db.getString(sqlResult, "id"); 

/*sql = "exec getCashTicket '" + db.encode(serialNumber) + "','"+db.encode(userId)+"'";
es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql);  
db.read(sqlResult);
es.logWarning(sql);
var errorCode = db.getInt32(sqlResult, "errorCode");
es.logWarning(errorCode);
if (errorCode!=0) {
    eio.appendString8("F");
    eio.appendString8(db.getString(sqlResult, "errorString"));
    return;
}*/
sql="select count(*) as c from cashTicket where serialNumber='"+db.encode(serialNumber)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
//es.logWarning(sql);
db.read(sqlResult);
var count=db.getInt32(sqlResult,"c");
if(count<1){
   eio.appendString8("F"); 
   eio.appendString8("代金券错误");
   return;
}

/*
sql="select count(*) as c from cashTicket where userId='"+db.encode(userId)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
es.logWarning(sql);
db.read(sqlResult);
var count=db.getInt32(sqlResult,"c");
if(count>0){
   eio.appendString8("F"); 
   eio.appendString8("您已经使用过代金券");
   return;
}
*/

sql="select * from cashTicket where serialNumber='"+db.encode(serialNumber)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
//es.logWarning(sql);
db.read(sqlResult);
var displayName = db.getString(sqlResult, "displayName");
var pay = db.getString(sqlResult, "pay");
var payFree = db.getString(sqlResult, "payFree");
var regDatetime = db.getString(sqlResult, "regDatetime");
var used = db.getString(sqlResult, "used");
var cashName = db.getString(sqlResult,"name"); 
var dieDatetime = db.getString(sqlResult,"dieDatetime");  


var nowdate = new Date();
var time1 = Date.parse(nowdate);
var nowtime = time1/1000; 

var dietime = Date.parse(new Date(dieDatetime));
 dietime = dietime /1000;

if (nowtime > dietime){
    eio.appendString8("F"); 
    eio.appendString8("您使用的优惠券已过期");
    return;
}

 
if (cashName == "南航积分201701"){
 
    if(used=="T"){
       eio.appendString8("F"); 
       eio.appendString8("该代金券已被使用");
       return;
    }
    if(used=="D"){
       eio.appendString8("F"); 
       eio.appendString8("您的优惠券已过期");
       return;
    }
          

}else {
    sql="select count(*) as c from cashTicket where userId='"+db.encode(userId)+"' and displayName = '"+ displayName+"'"; 
    sqlResult = db.executeQuery("PJ", sql);  
   // es.logWarning(sql);
    db.read(sqlResult);
    var count=db.getInt32(sqlResult,"c");
    if(count>0){
       eio.appendString8("F"); 
       eio.appendString8("您已经使用过该类代金券");
       return;
    }
     
    if(used=="T"){
       eio.appendString8("F"); 
       eio.appendString8("该代金券已被使用");
       return;
    }
    
    if(used=="D"){
       eio.appendString8("F"); 
       eio.appendString8("您的优惠券已过期");
       return;
    }   
}
eio.appendString8("T"); 
eio.appendString8(displayName);
eio.appendString8(pay);
eio.appendString8(payFree);
eio.appendString8(regDatetime);
eio.appendString8(used);

]]></script2>
      <script3><![CDATA[var result = eio.readString8();   
if (result=="F") {
    alert("优惠券使用失败：" + eio.readString8());
    return;
} 
var displayName =eio.readString8();
var pay =eio.readString8();
var payFree =eio.readString8();
var regDatetime =eio.readString8();
var used =eio.readString8();
var index = regDatetime.indexOf(" "); 
regDatetime = regDatetime.substr(0,index);
if(used=="T"){
    alert("该优惠券已过期或已被使用");
    return;
} 
else {
    used="可使用";
}
var text="优惠券名称："+displayName+"<br />包含金额："+pay.substring(0,pay.indexOf(".") + 3)+"<br />包含积分："+payFree.substring(0,payFree.indexOf(".") + 3)+"<br />使用状态："+used;
ee.setText(ee.getControl("panel50"),text); 
ee.showAni(ee.getControl("panel43"));
]]></script3>
    </taskSetItem>
    <taskSetItem name="updateVouchers">
      <script1>var result=ee.getEditText(ee.getControl("edit1"));
result = result.replace(/\s+/g,"");
eio.appendString8(result);
eio.appendString8(eb.getCookie("pjToken"));
</script1>
      <script2><![CDATA[var serialNumber = eio.readString8();
var token = eio.readString8();  
var date = new Date();
var seperator1 = "-";
var seperator2 = ":";
var month = date.getMonth() + 1;
var strDate = date.getDate();
if (month >= 1 &amp;&amp; month <= 9) {
    month = "0" + month;
}
if (strDate >= 0 &amp;&amp; strDate <= 9) {
    strDate = "0" + strDate;
}
var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate+ " " + date.getHours() + seperator2 + date.getMinutes()+ seperator2 + date.getSeconds(); 
var sql,sqlResult; 
sql = "exec getUserInfoBySession '" + db.encode(token) + "'";
sqlResult = db.executeQuery("PJ", sql);
if (sqlResult == null) {
    eio.appendString8("F");
    es.logWarning("数据库执行错误, sql=" + sql);
    return;
}
db.read(sqlResult);
if (db.getString(sqlResult, "sessionId").length < 5) {
    eio.appendString8("F");
    eio.appendString8("token失效");
    es.logWarning("用户token失效, sql=" + sql);
    return;
} 
var userId = db.getString(sqlResult, "id");

sql = "exec useCashTicket '" + db.encode(serialNumber) + "','"+db.encode(userId)+"'";
//es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql);  
db.read(sqlResult);
//es.logWarning(sql);
var errorCode = db.getInt32(sqlResult, "errorCode");
//es.logWarning(errorCode);
if (errorCode!=0) {
    eio.appendString8("F");
    eio.appendString8(db.getString(sqlResult, "errorString"));
    return;
}
   
/*
sql="update cashTicket set  useDatetime='"+db.encode(currentdate)+"',used='T',userId='"+db.encode(userId)+"' where serialNumber='"+db.encode(serialNumber)+"'" 
es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql); 

db.read(sqlResult);

//查出优惠券对应的上级Id
sql="select * from cashTicket where serialNumber='"+db.encode(serialNumber)+"'" 
es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql); 
es.logWarning(sql);
db.read(sqlResult);
var superior = db.getString(sqlResult,"superior"); 

 
if(superior != "" &amp;&amp; superior != null &amp;&amp; superior !="0"){
    //添加关系
    sql = "exec treeAdd '"+ userId +"','"+ superior +"'";
    db.executeNoneQuery("PJ",sql);

}
 */

eio.appendString8("T");
]]></script2>
      <script3>var result =eio.readString8();
if(result=="F"){
    alert("系统繁忙，请稍候再试！");
    return;
}
alert("优惠券使用成功！");  
ee.setVisible(ee.getControl("panel43"), false);
</script3>
    </taskSetItem>
  </taskSet>
  <gridLines count="0" />
</page>