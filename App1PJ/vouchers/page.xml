<page>
  <controls count="17">
    <control type="DivRoot" pathname="/divRoot">
      <left>0</left>
      <top>0</top>
      <width>1202</width>
      <height>819</height>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <backgroundColor>ffffff</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <onControlLoad><![CDATA[var isIOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
if (!isIOS) {
    ee.getControl("layoutyitem1").heavy = 0;
}
setTimeout(function(){
    ee.autoResize = false;
},1000);
ee.getControl("panel2").ontouchend=function(){
   // alert();    
   var text=ee.getEditText(ee.getControl("edit1")) 

   if(text.length <=0){
       alert("代金券号不能为空！"); 
       return;
   }  
   getVouchers();                             
   
}


]]></onControlLoad>
      <pageHead><![CDATA[<meta name="viewport" content="width=device-width, minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">]]></pageHead>
    </control>
    <control type="LayoutY" pathname="/divRoot/layouty1">
      <left>0</left>
      <top>0</top>
      <width>1202</width>
      <height>90</height>
      <widthRatio>1</widthRatio>
      <heightRatio>0.10989010989011</heightRatio>
      <sizeRatio>0.149750415973378</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fieldCount>2</fieldCount>
    </control>
    <control type="LayoutYItem" pathname="/divRoot/layouty1/layoutyitem1">
      <left>0</left>
      <top>0</top>
      <width>1202</width>
      <height>29</height>
      <widthRatio>1</widthRatio>
      <heightRatio>0.322222222222222</heightRatio>
      <sizeRatio>0.024126455906822</sizeRatio>
      <backgroundColor>BFCEDF</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <heavy>47</heavy>
    </control>
    <control type="LayoutYItem" pathname="/divRoot/layouty1/layoutyitem2">
      <left>0</left>
      <top>29</top>
      <width>1202</width>
      <height>61</height>
      <topRatio>0.322222222222222</topRatio>
      <widthRatio>1</widthRatio>
      <heightRatio>0.677777777777778</heightRatio>
      <sizeRatio>0.0507487520798669</sizeRatio>
      <backgroundColor>47A9F9</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <text>使用代金券</text>
      <fontSizeAuto>15</fontSizeAuto>
      <fontColor>FFFFFF</fontColor>
    </control>
    <control type="Panel" pathname="/divRoot/layouty1/layoutyitem2/panel8">
      <left>33</left>
      <top>13</top>
      <width>142</width>
      <height>34</height>
      <leftRatio>0.0274442538593482</leftRatio>
      <topRatio>0.213114754098361</topRatio>
      <widthRatio>0.118353344768439</widthRatio>
      <heightRatio>0.557377049180328</heightRatio>
      <sizeRatio>0.492753623188406</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <backgroundImg>back.png</backgroundImg>
      <backgroundImgMode>fill</backgroundImgMode>
      <fontSizeAuto>30</fontSizeAuto>
      <cursor>pointer</cursor>
    </control>
    <control type="Panel" pathname="/divRoot/layouty1/layoutyitem2/panel10">
      <left>2</left>
      <top>1</top>
      <width>234</width>
      <height>57</height>
      <leftRatio>0.00166389351081531</leftRatio>
      <topRatio>0.0163934426229508</topRatio>
      <widthRatio>0.194675540765391</widthRatio>
      <heightRatio>0.934426229508197</heightRatio>
      <sizeRatio>0.487179487179487</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <backgroundSkin>empty</backgroundSkin>
      <onClick>window.location.href = ee.pageRoot + "/pay";
</onClick>
    </control>
    <control type="Edit" pathname="/divRoot/edit1">
      <left>168</left>
      <top>133</top>
      <width>864</width>
      <height>51</height>
      <leftRatio>0.13997113997114</leftRatio>
      <topRatio>0.162393162393162</topRatio>
      <widthRatio>0.718614718614719</widthRatio>
      <heightRatio>0.0622710622710623</heightRatio>
      <sizeRatio>0.0512048192771084</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <backgroundSkin>edit1</backgroundSkin>
    </control>
    <control type="Panel" pathname="/divRoot/panel1">
      <left>746</left>
      <top>190</top>
      <width>282</width>
      <height>57</height>
      <leftRatio>0.620490620490621</leftRatio>
      <topRatio>0.231990231990232</topRatio>
      <widthRatio>0.234487734487734</widthRatio>
      <heightRatio>0.0695970695970696</heightRatio>
      <sizeRatio>0.175384615384615</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <text>代金券使用规则</text>
      <fontSizeAuto>32</fontSizeAuto>
      <fontColor>808080</fontColor>
    </control>
    <control type="Panel" pathname="/divRoot/panel2">
      <left>168</left>
      <top>246</top>
      <width>864</width>
      <height>63</height>
      <leftRatio>0.13997113997114</leftRatio>
      <topRatio>0.3003663003663</topRatio>
      <widthRatio>0.718614718614719</widthRatio>
      <heightRatio>0.0769230769230769</heightRatio>
      <sizeRatio>0.0632530120481928</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <backgroundSkin>button3</backgroundSkin>
      <text>使用代金券</text>
      <fontSizeAuto>20</fontSizeAuto>
      <fontColor>FFFFFF</fontColor>
    </control>
    <control type="Panel" pathname="/divRoot/panel43">
      <left>0</left>
      <top>0</top>
      <width>1202</width>
      <height>819</height>
      <widthRatio>1</widthRatio>
      <heightRatio>1</heightRatio>
      <sizeRatio>0.681364392678869</sizeRatio>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <backgroundColor>000000</backgroundColor>
      <backgroundImg>dialogMask.png</backgroundImg>
      <backgroundImgMode>stretch</backgroundImgMode>
      <layerName>m1</layerName>
      <layerVisible>false</layerVisible>
      <aniAlpha>whiteAlpha:白色淡出</aniAlpha>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3">
      <left>119</left>
      <top>153</top>
      <width>933</width>
      <height>443</height>
      <leftRatio>0.0990990990990991</leftRatio>
      <topRatio>0.186813186813187</topRatio>
      <widthRatio>0.776412776412776</widthRatio>
      <heightRatio>0.540903540903541</heightRatio>
      <sizeRatio>0.467299578059072</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <backgroundSkin>button3a000</backgroundSkin>
      <fontSizeAuto>20</fontSizeAuto>
      <fontColor>FFFFFF</fontColor>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel9">
      <left>24</left>
      <top>60</top>
      <width>873</width>
      <height>57</height>
      <leftRatio>0.0256959314775161</leftRatio>
      <topRatio>0.135440180586907</topRatio>
      <widthRatio>0.93576017130621</widthRatio>
      <heightRatio>0.128668171557562</heightRatio>
      <sizeRatio>0.130434782608696</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <text>代金券详情</text>
      <fontSizeAuto>30</fontSizeAuto>
      <fontBold>true</fontBold>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel47">
      <left>201</left>
      <top>345</top>
      <width>510</width>
      <height>54</height>
      <leftRatio>0.215317919075144</leftRatio>
      <topRatio>0.778781038374718</topRatio>
      <widthRatio>0.546242774566474</widthRatio>
      <heightRatio>0.121896162528217</heightRatio>
      <sizeRatio>0.142857142857143</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <backgroundSkin>button3000</backgroundSkin>
      <text>取消</text>
      <fontSizeAuto>25</fontSizeAuto>
      <fontColor>FFFFFF</fontColor>
      <cursor>pointer</cursor>
      <onClick>ee.setVisible(ee.getControl("panel43"), false);</onClick>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel13">
      <left>42</left>
      <top>10</top>
      <width>224</width>
      <height>47</height>
      <leftRatio>0.0449678800856531</leftRatio>
      <topRatio>0.0225733634311512</topRatio>
      <widthRatio>0.23982869379015</widthRatio>
      <heightRatio>0.106094808126411</heightRatio>
      <sizeRatio>0.419642857142857</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <text>使用代金券</text>
      <fontSizeAuto>30</fontSizeAuto>
      <fontColor>48A1DD</fontColor>
      <fontBold>true</fontBold>
      <hAlign>left</hAlign>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel14">
      <left>38</left>
      <top>52</top>
      <width>851</width>
      <height>2</height>
      <leftRatio>0.040650406504065</leftRatio>
      <topRatio>0.117794486215539</topRatio>
      <widthRatio>0.91260162601626</widthRatio>
      <heightRatio>0.0050125313283208</heightRatio>
      <sizeRatio>0.0044543429844098</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <backgroundColor>48A1DD</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel50">
      <left>120</left>
      <top>108</top>
      <width>675</width>
      <height>155</height>
      <leftRatio>0.128612716763006</leftRatio>
      <topRatio>0.243792325056433</topRatio>
      <widthRatio>0.723988439306358</widthRatio>
      <heightRatio>0.349887133182844</heightRatio>
      <sizeRatio>0.30938123752495</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <text>详情：</text>
      <fontSizeAuto>27</fontSizeAuto>
      <fontColor>404040</fontColor>
      <hAlign>left</hAlign>
      <vAlign>top</vAlign>
    </control>
    <control type="Panel" pathname="/divRoot/panel43/panel3/panel16">
      <left>200</left>
      <top>280</top>
      <width>511</width>
      <height>54</height>
      <leftRatio>0.213872832369942</leftRatio>
      <topRatio>0.632054176072235</topRatio>
      <widthRatio>0.547687861271676</widthRatio>
      <heightRatio>0.121896162528217</heightRatio>
      <sizeRatio>0.142480211081794</sizeRatio>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <backgroundSkin>button3</backgroundSkin>
      <text>确认使用</text>
      <fontSizeAuto>25</fontSizeAuto>
      <fontColor>FFFFFF</fontColor>
      <cursor>pointer</cursor>
      <onClick>//alert(money)     
//payNews();
//window.location.href = ee.pageRoot + "/student/sMain";
updateVouchers();  

</onClick>
    </control>
  </controls>
  <taskSet count="2">
    <taskSetItem name="getVouchers">
      <script1>var result=ee.getEditText(ee.getControl("edit1"));
result = result.replace(/\s+/g,"");
eio.appendString8(result);
   
eio.appendString8(eb.getCookie("pjToken"));
</script1>
      <script2><![CDATA[var serialNumber = eio.readString8();
var token = eio.readString8();
var sql,sqlResult;   

sql = "exec getUserInfoBySession '" + db.encode(token) + "'";
sqlResult = db.executeQuery("PJ", sql); 
es.logWarning(sql);
if (sqlResult == null) {
    eio.appendString8("F");
    es.logWarning("数据库执行错误, sql=" + sql);
    return;
}
db.read(sqlResult);
if (db.getString(sqlResult, "sessionId").length < 5) {
    eio.appendString8("F");
    eio.appendString8("token失效");
    es.logWarning("用户token失效, sql=" + sql);
    return;
} 
var userId = db.getString(sqlResult, "id"); 

sql = "exec getCashTicket '" + db.encode(serialNumber) + "','"+db.encode(userId)+"'";
es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql);  
db.read(sqlResult);
es.logWarning(sql);
var errorCode = db.getInt32(sqlResult, "errorCode");
es.logWarning(errorCode);
if (errorCode!=0) {
    eio.appendString8("F");
    eio.appendString8(db.getString(sqlResult, "errorString"));
    return;
}

sql="select * from cashTicket where serialNumber='"+db.encode(serialNumber)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
es.logWarning(sql);
db.read(sqlResult);
var displayName = db.getString(sqlResult, "displayName");
var pay = db.getString(sqlResult, "pay");
var payFree = db.getString(sqlResult, "payFree");
var regDatetime = db.getString(sqlResult, "regDatetime");
var used = db.getString(sqlResult, "used");
eio.appendString8("T"); 
eio.appendString8(displayName);
eio.appendString8(pay);
eio.appendString8(payFree);
eio.appendString8(regDatetime);
eio.appendString8(used);

]]></script2>
      <script3><![CDATA[var result = eio.readString8();   
if (result=="F") {
    alert("代金券使用失败：" + eio.readString8());
    return;
} 
var displayName =eio.readString8();
var pay =eio.readString8();
var payFree =eio.readString8();
var regDatetime =eio.readString8();
var used =eio.readString8(); 
if(used=="T"){
    alert("该代金券已过期或已被使用");
    return;
} 
else {
    used="可使用";
}
var text="代金券名称："+displayName+"<br />包含金额："+pay.substring(0,pay.indexOf(".") + 3)+"<br />包含赠送金额："+payFree.substring(0,payFree.indexOf(".") + 3)+"<br />发行时间："+regDatetime+"<br />使用状态："+used;
ee.setText(ee.getControl("panel50"),text); 
ee.showAni(ee.getControl("panel43"));
]]></script3>
    </taskSetItem>
    <taskSetItem name="updateVouchers">
      <script1>var result=ee.getEditText(ee.getControl("edit1"));
result = result.replace(/\s+/g,"");
eio.appendString8(result);
eio.appendString8(eb.getCookie("pjToken"));
</script1>
      <script2><![CDATA[var serialNumber = eio.readString8();
var token = eio.readString8();  
var date = new Date();
var seperator1 = "-";
var seperator2 = ":";
var month = date.getMonth() + 1;
var strDate = date.getDate();
if (month >= 1 &amp;&amp; month <= 9) {
    month = "0" + month;
}
if (strDate >= 0 &amp;&amp; strDate <= 9) {
    strDate = "0" + strDate;
}
var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate+ " " + date.getHours() + seperator2 + date.getMinutes()+ seperator2 + date.getSeconds(); 
var sql,sqlResult; 
sql = "exec getUserInfoBySession '" + db.encode(token) + "'";
sqlResult = db.executeQuery("PJ", sql);
if (sqlResult == null) {
    eio.appendString8("F");
    es.logWarning("数据库执行错误, sql=" + sql);
    return;
}
db.read(sqlResult);
if (db.getString(sqlResult, "sessionId").length < 5) {
    eio.appendString8("F");
    eio.appendString8("token失效");
    es.logWarning("用户token失效, sql=" + sql);
    return;
} 
var userId = db.getString(sqlResult, "id");

sql="update cashTicket set  useDatetime='"+db.encode(currentdate)+"',used='T',userId='"+db.encode(userId)+"' where serialNumber='"+db.encode(serialNumber)+"'" 
es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql); 
es.logWarning(sql);
db.read(sqlResult);
eio.appendString8("T");
]]></script2>
      <script3>var result =eio.readString8();
if(result=="F"){
    alert("系统繁忙，请稍候再试！");
    return;
}
alert("代金券使用成功！");  
ee.setVisible(ee.getControl("panel43"), false);
</script3>
    </taskSetItem>
  </taskSet>
  <gridLines count="0" />
</page>