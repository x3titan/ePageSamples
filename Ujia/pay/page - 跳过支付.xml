<page>
  <controls count="23">
    <control type="DivRoot" pathname="/divRoot">
      <backgroundColor>ffffff</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <height>816</height>
      <left>0</left>
      <onControlLoad>//付款 按钮圆角设置
var c = ee.getControl("panel22");
c.style.borderRadius = "3px";   
var c2 = ee.getControl("panel15");
c2.style.borderRadius = "3px"; 

//获取insert_id 和　back＿url    

var url = window.location.href;
var index = url.indexOf("=/");
url = url.substring(index + 1);
var arr = url.split("red_url");     

var url_orig = arr[0];  // "/Ujia/pay&amp;insert_id=1430&amp;back_url=/Ujia/shoplist%26id%3D2170%26token%3Ddemo%26"
var url_red = arr[1];   // "%3D/simulation/path%23id%3D13%23token%3Ddemo"

var arr_orig = url_orig.split("&amp;back_url=");
var url_use = arr_orig[0];
var url_back = arr_orig[1];  

var index2 = url_use.indexOf("insert_id=");
var insert_id = url_use.substring(index2 + "insert_id".length);
//console.log(insert_id);
url_back = unescape(url_back);   
var index3 = url_back.indexOf("/shoplist");
url_back = url_back.substring(index3);
//console.log(url_back);           

url_red = unescape(url_red); 
var back_url = url_back + "red_url" + url_red; 
//console.log(back_url);
  
     
  /*
var insert_id = eb.getCookie("insert_id");
var back_url = eb.getCookie("back_url");       
*/
g5.insert_id = insert_id;
g5.back_url = back_url;   


/*
//截取code
var url = window.location.search;
var arr = url.split("&amp;");  
if(arr[1] != "" &amp;&amp; arr[1] != undefined){
    var tmp_code = arr[1].toLocaleLowerCase();
    var index = tmp_code.indexOf("code=");  
    if(index != -1){
        var code = arr[1].substring(index + "code=".length);
        g5.code = code;    
    }else {
        alert("url出错，获取code失败");
        g5.code = "";  
        console.log("url出错，获取code失败");
    }  
}else {
    alert("地址出错，获取code失败");
    g5.code = "";  
    console.log("地址出错，获取code失败");
}      
  */
  
getInfo();






  
</onControlLoad>
      <pageHead><![CDATA[<meta name="viewport" content="width=device-width, minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">       
<script type="text/javascript"src="/eEngine/Scripts/timestamp.js"></script>]]></pageHead>
      <top>0</top>
      <width>512</width>
    </control>
    <control type="Panel" pathname="/divRoot/panel1">
      <backgroundColor>F5F5F5</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>816</height>
      <heightRatio>1</heightRatio>
      <left>0</left>
      <sizeRatio>1.96626506024096</sizeRatio>
      <top>0</top>
      <width>512</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel2">
      <backgroundColor>FFFFFF</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontBold>true</fontBold>
      <fontSizeAuto>20</fontSizeAuto>
      <height>55</height>
      <heightRatio>0.0674019607843137</heightRatio>
      <left>0</left>
      <sizeRatio>0.120087336244541</sizeRatio>
      <text>收银台</text>
      <top>0</top>
      <width>512</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel2/panel6">
      <backgroundImg>fanhui.png</backgroundImg>
      <backgroundImgMode>fill</backgroundImgMode>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>20</height>
      <heightRatio>0.363636363636364</heightRatio>
      <left>16</left>
      <leftRatio>0.0313253012048193</leftRatio>
      <onClick>window.location.href = ee.pageRoot + g5.back_url;</onClick>
      <sizeRatio>1.17647058823529</sizeRatio>
      <top>17</top>
      <topRatio>0.309090909090909</topRatio>
      <width>21</width>
      <widthRatio>0.0409638554216867</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3">
      <backgroundColor>FFFFFF</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>150</height>
      <heightRatio>0.183823529411765</heightRatio>
      <left>0</left>
      <sizeRatio>0.36144578313253</sizeRatio>
      <top>63</top>
      <topRatio>0.0772058823529412</topRatio>
      <width>512</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel4">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>40</height>
      <heightRatio>0.266666666666667</heightRatio>
      <left>0</left>
      <sizeRatio>0.0873362445414847</sizeRatio>
      <top>14</top>
      <topRatio>0.0933333333333333</topRatio>
      <width>512</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel4/panel5">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>707070</fontColor>
      <fontSizeAuto>25</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>40</height>
      <heightRatio>1</heightRatio>
      <left>25</left>
      <leftRatio>0.0480349344978166</leftRatio>
      <sizeRatio>0.5</sizeRatio>
      <text>订单号:</text>
      <top>0</top>
      <vAlign>bottom</vAlign>
      <width>89</width>
      <widthRatio>0.174672489082969</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel4/panel7">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FF0000</fontColor>
      <fontFamily>Arial</fontFamily>
      <fontSizeAuto>27</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>40</height>
      <heightRatio>1</heightRatio>
      <left>112</left>
      <leftRatio>0.218340611353712</leftRatio>
      <sizeRatio>0.130718954248366</sizeRatio>
      <text>.</text>
      <top>0</top>
      <vAlign>bottom</vAlign>
      <width>342</width>
      <widthRatio>0.668122270742358</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel8">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>40</height>
      <heightRatio>0.266666666666667</heightRatio>
      <left>0</left>
      <sizeRatio>0.0873362445414847</sizeRatio>
      <top>55</top>
      <topRatio>0.366666666666667</topRatio>
      <width>512</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel8/panel9">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>707070</fontColor>
      <fontSizeAuto>25</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>40</height>
      <heightRatio>1</heightRatio>
      <left>25</left>
      <leftRatio>0.0480349344978166</leftRatio>
      <sizeRatio>0.363636363636364</sizeRatio>
      <text>订单总额:</text>
      <top>0</top>
      <width>123</width>
      <widthRatio>0.240174672489083</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel8/panel10">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FF0000</fontColor>
      <fontFamily>Arial</fontFamily>
      <fontSizeAuto>27</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>40</height>
      <heightRatio>1</heightRatio>
      <left>135</left>
      <leftRatio>0.264192139737991</leftRatio>
      <sizeRatio>0.144927536231884</sizeRatio>
      <text>.</text>
      <top>0</top>
      <width>309</width>
      <widthRatio>0.602620087336245</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel11">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>40</height>
      <heightRatio>0.266666666666667</heightRatio>
      <left>0</left>
      <sizeRatio>0.0873362445414847</sizeRatio>
      <top>95</top>
      <topRatio>0.633333333333333</topRatio>
      <width>512</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel11/panel12">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>707070</fontColor>
      <fontSizeAuto>25</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>40</height>
      <heightRatio>1</heightRatio>
      <left>25</left>
      <leftRatio>0.0480349344978166</leftRatio>
      <sizeRatio>0.363636363636364</sizeRatio>
      <text>订单日期:</text>
      <top>0</top>
      <vAlign>top</vAlign>
      <width>123</width>
      <widthRatio>0.240174672489083</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel11/panel13">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FF0000</fontColor>
      <fontFamily>Arial</fontFamily>
      <fontSizeAuto>27</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>40</height>
      <heightRatio>1</heightRatio>
      <left>135</left>
      <leftRatio>0.264192139737991</leftRatio>
      <sizeRatio>0.144927536231884</sizeRatio>
      <text>.</text>
      <top>0</top>
      <vAlign>top</vAlign>
      <width>309</width>
      <widthRatio>0.602620087336245</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel14">
      <backgroundColor>FFFFFF</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>90</height>
      <heightRatio>0.110294117647059</heightRatio>
      <left>0</left>
      <sizeRatio>0.196506550218341</sizeRatio>
      <top>225</top>
      <topRatio>0.275735294117647</topRatio>
      <width>512</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel14/panel15">
      <backgroundImg>weixin.png</backgroundImg>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>50</height>
      <heightRatio>0.555555555555556</heightRatio>
      <left>25</left>
      <leftRatio>0.0480349344978166</leftRatio>
      <sizeRatio>0.649350649350649</sizeRatio>
      <top>20</top>
      <topRatio>0.222222222222222</topRatio>
      <width>86</width>
      <widthRatio>0.168122270742358</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel14/panel16">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>333333</fontColor>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>24</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>30</height>
      <heightRatio>0.333333333333333</heightRatio>
      <left>123</left>
      <leftRatio>0.240174672489083</leftRatio>
      <sizeRatio>0.133333333333333</sizeRatio>
      <text>微信支付</text>
      <top>20</top>
      <topRatio>0.222222222222222</topRatio>
      <width>252</width>
      <widthRatio>0.491266375545852</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel14/panel17">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>707070</fontColor>
      <fontSizeAuto>27</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>25</height>
      <heightRatio>0.277777777777778</heightRatio>
      <left>123</left>
      <leftRatio>0.240174672489083</leftRatio>
      <sizeRatio>0.111111111111111</sizeRatio>
      <text>急速、安全、新体验</text>
      <top>48</top>
      <topRatio>0.533333333333333</topRatio>
      <width>252</width>
      <widthRatio>0.491266375545852</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel14/panel18">
      <backgroundImg>yuan2.png</backgroundImg>
      <backgroundImgMode>fill</backgroundImgMode>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>25</height>
      <heightRatio>0.277777777777778</heightRatio>
      <left>449</left>
      <leftRatio>0.87710843373494</leftRatio>
      <onClick>var text = ee.getText(this.parentNode.eeChildren[1]);
//console.log(text);
if (text == "设为默认使用人"){
    var index = (this.parentNode.parentNode.parentNode).rowIndex;     
    g5.choose_id = ee.getText(ee.getControl("tablebody1").cols[0].rows[index]);
    changeDefault();
}else {
    return;
}</onClick>
      <sizeRatio>0.961538461538462</sizeRatio>
      <top>32</top>
      <topRatio>0.355555555555556</topRatio>
      <width>32</width>
      <widthRatio>0.0626506024096386</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel19">
      <backgroundColor>FFFFFF</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <height>60</height>
      <heightRatio>0.0735294117647059</heightRatio>
      <left>0</left>
      <sizeRatio>0.144578313253012</sizeRatio>
      <top>755</top>
      <topRatio>0.925245098039216</topRatio>
      <width>512</width>
      <widthRatio>1</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel19/panel20">
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>333333</fontColor>
      <fontSizeAuto>22</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>35</height>
      <heightRatio>0.583333333333333</heightRatio>
      <left>25</left>
      <leftRatio>0.0480349344978166</leftRatio>
      <sizeRatio>0.479452054794521</sizeRatio>
      <text>支付：</text>
      <top>12</top>
      <topRatio>0.2</topRatio>
      <width>82</width>
      <widthRatio>0.15938864628821</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel19/panel21">
      <dockY>ratio</dockY>
      <fontBold>true</fontBold>
      <fontColor>D30011</fontColor>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>21</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>35</height>
      <heightRatio>0.583333333333333</heightRatio>
      <left>81</left>
      <leftRatio>0.176855895196507</leftRatio>
      <sizeRatio>0.35</sizeRatio>
      <text>.￥33333</text>
      <top>12</top>
      <topRatio>0.2</topRatio>
      <widthRatio>0.218340611353712</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel19/panel22">
      <backgroundColor>D5001A</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>ratio</dockX>
      <dockY>ratio</dockY>
      <fontColor>FFFFFF</fontColor>
      <fontSizeAuto>22</fontSizeAuto>
      <height>35</height>
      <heightRatio>0.583333333333333</heightRatio>
      <left>353</left>
      <leftRatio>0.689956331877729</leftRatio>
      <onClick>//pay();
skipPay();</onClick>
      <sizeRatio>0.28</sizeRatio>
      <text>付款</text>
      <top>12</top>
      <topRatio>0.2</topRatio>
      <width>140</width>
      <widthRatio>0.27292576419214</widthRatio>
    </control>
  </controls>
  <taskSet count="3">
    <taskSetItem name="getInfo">
      <script1>eio.appendString8(g5.insert_id)</script1>
      <script2>var id = eio.readString8();

var sql,sqlResult;
sql = "select * from ujia_order where id = '"+ db.encode(id) +"'";
sqlResult = db.executeQuery("UJ",sql);
if(sqlResult == null){
    eio.appendString8("F");
    eio.appendString8("查询订单表失败");
    return; 
}
db.read(sqlResult);
var orderid = db.getString(sqlResult,"orderid"); 
var create_time = db.getString(sqlResult,"create_time");
var project_name = db.getString(sqlResult,"project_name");
var total_money = db.getString(sqlResult,"total_money");   
var pay_money = db.getString(sqlResult,"pay_money");  
var goods_id = db.getString(sqlResult,"goods_id");
//var pay_money = db.getString(sqlResult,"pay_money");

eio.appendString8("T");
eio.appendString8(orderid); 
eio.appendString8(create_time);
eio.appendString8(project_name);
eio.appendString8(total_money);
eio.appendString8(pay_money);
eio.appendString8(goods_id);</script2>
      <script3>var code = eio.readString8();
if (code != "T"){
    alert("出错："+ eio.readString8());
    return;
}

var orderid = eio.readString8();
var create_time = eio.readString8();
var project_name = eio.readString8();
var total_money = eio.readString8();
var pay_money = eio.readString8();
var goods_id = eio.readString8(); 

g5.orderid = orderid;
g5.pay_money = pay_money;

console.log(orderid);
console.log(pay_money);
console.log(create_time);   


var payMoney = ""; 
var dateTime = "";  
if (create_time != ""){
    dateTime = ts.getDateTimeTS(create_time);  
}
var payMoney = ""; 
if (pay_money != ""){
    payMoney = "￥"+ pay_money;
}
ee.setText(ee.getControl("panel7"),orderid); 
ee.setText(ee.getControl("panel10"),pay_money);
ee.setText(ee.getControl("panel13"),dateTime);      
ee.setText(ee.getControl("panel21"),payMoney);</script3>
    </taskSetItem>
    <taskSetItem name="pay">
      <script1>var orderId = g5.orderid;
var money = g5.pay_money;     
var code = g5.code;   
if (code == ""){
    alert("code获取失败，请重新获取");
    return;
}

eio.appendString8(orderId);
eio.appendString8(money);   
eio.appendString8(code);
                           
console.log("orderid="+orderId+" ,money="+money);</script1>
      <script2><![CDATA[var orderId = eio.readString8();
var money = eio.readString8();
var code = eio.readString8();

es.logWarning("orderid="+orderId+" money="+money);     

var oid =session.get("openid");   
//es.logWarning("oid="+oid);
if(oid==""){
//es.logWarning("code:"+code);
var get = es.get("https://api.weixin.qq.com/sns/oauth2/access_token?appid=wxeeb9b2f6e1f01d23&amp;secret=3efec074c3b012d58e297a1d75265f3b&amp;code="+code+"&amp;grant_type=authorization_code");
//es.logWarning("get="+get);
get=JSON.stringify(get);
//es.logWarning("get1="+get);
 
var json=get.split(","); 
//es.logWarning("json="+json);
var access=json[3].split(":"); 
//es.logWarning("access="+access);
var a=access[1].split("\""); 
//es.logWarning("a="+access[1]); 
    var openid=a[1]; 
    openid=openid.substr(0,openid.length-1); 
 // es.logWarning("openid="+openid);
  session.set("openid",openid);
}else {
    var openid = oid;
}   

var payMoney = money * 100;  
/* 
if(mobile=="15726816163"){
   var payMoney=0.01*100;
} */ 
                            
var localTicket = orderId;  
 
var data = "";
var sign = "";
var randString = "A" + (new Date()).getTime();
randString = es.getMd5(randString).toUpperCase();
//计算sign
sign += "appid=wxeeb9b2f6e1f01d23";
sign += "&amp;attach=充值";
sign += "&amp;body=优驾充值";
sign += "&amp;mch_id=1239143502";  
sign += "&amp;nonce_str=" + randString;
sign += "&amp;notify_url=http://m.1peijia.com/EEngine/ee.aspx"; 
sign += "&amp;openid="+openid;//o_2KrszDgDmw--9LpCQqomVr1lF0
sign += "&amp;out_trade_no=" + localTicket;
sign += "&amp;spbill_create_ip=127.0.0.1";
sign += "&amp;total_fee=" + payMoney;
sign += "&amp;trade_type=JSAPI";
sign += "&amp;key=YIpeijia123456789012345678901234";
sign = es.getMd5(sign).toUpperCase();
//产生递交数据
data =
    "<xml>\n" + 
    "   <appid>wxeeb9b2f6e1f01d23</appid>\n" + //不解释
    "   <attach>充值</attach>\n" + //附加数据，在查询API和支付通知中原样返回，该字段主要用于商户携带订单的自定义数据
    "   <body>优驾充值</body>\n" + //商品或支付单简要描述
    "   <mch_id>1239143502</mch_id>\n" + //微信支付分配的商户号
    "   <nonce_str>" + randString + "</nonce_str>\n" + //随机字符串，不长于32位
    "   <notify_url>http://m.1peijia.com/EEngine/ee.aspx</notify_url>\n" + //接收微信支付异步通知回调地址，通知url必须为直接可访问的url，不能携带参数。
    //"   <openid>o_2KrszDgDmw--9LpCQqomVr1lF0</openid>\n"+ 
    "   <openid>"+ openid +"</openid>\n"+
    "   <out_trade_no>" + localTicket + "</out_trade_no>\n" + //商户系统内部的订单号,32个字符内、可包含字母
    "   <spbill_create_ip>127.0.0.1</spbill_create_ip>\n" + //用户端实际ip
    "   <total_fee>" + payMoney + "</total_fee>\n" + //订单总金额，单位（分）
    "   <trade_type>JSAPI</trade_type>\n" + //支付类型  
   // "   <openid>DFvSN8MRQrV6R-AAbUY-xmVslmrAuSkzgkaklzlgc8jCICHtOBVjiQEGtXqMTajWKesn80u_DKMAON5tq35_djNvavBeVmG-_73RdlWnHnqWybEVuilsv10pzuVc8fgmDIPfAJAJOV</openid>\n"+
     "   <sign>" + sign + "</sign>\n" +
    "</xml>\n";
//post   


var result = es.post("https://api.mch.weixin.qq.com/pay/unifiedorder", data);
/* 返回消息
<xml><return_code><![CDATA[SUCCESS]]]]><![CDATA[></return_code>
<return_msg><![CDATA[OK]]]]><![CDATA[></return_msg>
<appid><![CDATA[wx9b5794aacbbdf257]]]]><![CDATA[></appid>
<mch_id><![CDATA[1264325101]]]]><![CDATA[></mch_id>
<nonce_str><![CDATA[heGKmfwAQ2zSjfAI]]]]><![CDATA[></nonce_str>
<sign><![CDATA[48BB46F9CCF2901D97F884EB44A7C5DF]]]]><![CDATA[></sign>
<result_code><![CDATA[SUCCESS]]]]><![CDATA[></result_code>
<prepay_id><![CDATA[wx20160520184034d34c9c543c0304138885]]]]><![CDATA[></prepay_id>
<trade_type><![CDATA[APP]]]]><![CDATA[></trade_type>
</xml>
*/
if (result.indexOf("<return_code><![CDATA[SUCCESS]]]]><![CDATA[>")<0) {  
   // eio.appendString16(result);
    eio.appendString8("F");
    eio.appendString16("微信支付接口暂时无法使用，请稍后再试");
    return;
}

//从返回值中提取prepay_id
var r = result.indexOf("<prepay_id><![CDATA["); 
/*
if (r<0) {
    eio.appendString8("F");
    eio.appendString16("微信支付接口暂时无法使用，请稍后再试");
    return;
}  
*/
r += "<prepay_id><![CDATA[".length;
var r1 = result.indexOf("]", r);
if (r1<0) {
    eio.appendString8("F");
    eio.appendString16("微信支付接口暂时无法使用，请稍后再试");
    return;
} 
var prepayId = result.substring(r, r1);
eio.appendString8("T");
eio.appendString16(prepayId);
eio.appendString16(randString);   
var paysign = "";
//计算sign
paysign += "appId=wxeeb9b2f6e1f01d23"; 
paysign += "&amp;nonceStr="+randString;
paysign += "&amp;package=prepay_id="+prepayId;       
paysign += "&amp;signType=MD5";  
paysign += "&amp;timeStamp=1395712654";  
paysign += "&amp;key=YIpeijia123456789012345678901234";
paysign = es.getMd5(paysign).toUpperCase();  
eio.appendString16(paysign);
eio.appendString8(localTicket);
]]></script2>
      <script3>
var r = eio.readString8(); 
//alert("r:"+r);
if (r!="T") {
    alert(eio.readString16());
    return;
}
var prepayId = eio.readString16();
var randString = eio.readString16();
var paysign = eio.readString16();  
var localTicket = eio.readString8(); 

g5.localTicket = localTicket;
             
/*
ee.setText(ee.getControl("panel1"),prepayId);  
ee.setText(ee.getControl("panel2"),randString);
  */

/*
alert("sign:"+sign)*/; 
function onBridgeReady(){ 
//alert("123");
   //alert("onbridge ready");
 WeixinJSBridge.invoke(
       "getBrandWCPayRequest", {
           "appId":"wxeeb9b2f6e1f01d23",     //公众号名称，由商户传入     
           "timeStamp":"1395712654",         //时间戳，自1970年以来的秒数     
           "nonceStr":randString, //随机串     
           "package":"prepay_id="+prepayId,                
           "signType":"MD5",        //微信签名方式：     
           "paySign":paysign//paysign //微信签名            
       },
       function(res){  
           //alert(res.err_msg);   
           if(res.err_msg == "get_brand_wcpay_request:ok" ) { 
               //alert("11"); 
               //checkInfo();              
               alert("支付成功"); 
               /*
               window.location.href = ee.pageRoot +"/downloadApp";   
               */
           }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
           else {
               alert("支付失败");
           }
       }  
   );  
}     
if (typeof WeixinJSBridge == "undefined"){
   if( document.addEventListener ){
       document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
   }else if (document.attachEvent){
       document.attachEvent('WeixinJSBridgeReady',onBridgeReady); 
       document.attachEvent('onWeixinJSBridgeReady',onBridgeReady);
   }  
}else{
   onBridgeReady();
}</script3>
    </taskSetItem>
    <taskSetItem name="skipPay">
      <script1>/*
    跳过支付    
*/ 

var orderid = g5.insert_id;    

eio.appendString16(orderid);

</script1>
      <script2>var orderid = eio.readString16();

var sql = "select * from ujia_order where orderid='" + db.encode(orderid) + "'";
var sqlResult = db.executeQuery("UJ",sql);

if (sqlResult == null){
    eio.appendString8("F");
    eio.appendString8("查询错误");
    return;
}          

db.read(sqlResult);
var status = db.getString(sqlResult,"status");
if (status != 0){
    eio.appendString8("F");
    eio.appendString8("订单状态不对");
    return;
}          

sql = "update ujia_order set status = 1 where orderid = '"+ db.encode(orderid)+"'";
sqlResult = db.executeQuery("UJ",sql);


eio.appendString8("T");
</script2>
      <script3>var c = eio.readString8();
if(c != "T"){
    alert(eio.readString8());
    return;
}          

alert("已跳过支付，订单状态修改成功");</script3>
    </taskSetItem>
  </taskSet>
  <gridLines count="0" />
</page>