<page>
  <controls count="10">
    <control type="DivRoot" pathname="/divRoot">
      <backgroundColor>ffffff</backgroundColor>
      <bgColorEnabled>true</bgColorEnabled>
      <dockX>fill</dockX>
      <dockY>fill</dockY>
      <height>816</height>
      <left>0</left>
      <top>0</top>
      <width>1356</width>
    </control>
    <control type="Panel" pathname="/divRoot/panel1">
      <dockX>center</dockX>
      <dockY>center</dockY>
      <height>762</height>
      <heightRatio>0.933823529411765</heightRatio>
      <layerVisible>false</layerVisible>
      <left>361</left>
      <leftRatio>0.26622418879056</leftRatio>
      <sizeRatio>1.2018927444795</sizeRatio>
      <top>27</top>
      <topRatio>0.0330882352941176</topRatio>
      <width>634</width>
      <widthRatio>0.467551622418879</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel5">
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>25</fontSizeAuto>
      <height>55</height>
      <heightRatio>0.0721784776902887</heightRatio>
      <left>15</left>
      <leftRatio>0.0236593059936909</leftRatio>
      <sizeRatio>0.55</sizeRatio>
      <text>券号</text>
      <top>14</top>
      <topRatio>0.0183727034120735</topRatio>
      <widthRatio>0.157728706624606</widthRatio>
    </control>
    <control type="Edit" pathname="/divRoot/panel1/edit1">
      <backgroundSkin>edit1</backgroundSkin>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>25</fontSizeAuto>
      <height>51</height>
      <heightRatio>0.0669291338582677</heightRatio>
      <inputFont>黑体</inputFont>
      <inputFontSizeAuto>25</inputFontSizeAuto>
      <left>127</left>
      <leftRatio>0.200315457413249</leftRatio>
      <sizeRatio>0.102409638554217</sizeRatio>
      <top>16</top>
      <topRatio>0.020997375328084</topRatio>
      <width>498</width>
      <widthRatio>0.785488958990536</widthRatio>
    </control>
    <control type="Edit" pathname="/divRoot/panel1/edit2">
      <backgroundSkin>edit1</backgroundSkin>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>25</fontSizeAuto>
      <height>51</height>
      <heightRatio>0.0669291338582677</heightRatio>
      <inputFont>黑体</inputFont>
      <inputFontSizeAuto>25</inputFontSizeAuto>
      <left>127</left>
      <leftRatio>0.200315457413249</leftRatio>
      <sizeRatio>0.102409638554217</sizeRatio>
      <top>90</top>
      <topRatio>0.118110236220472</topRatio>
      <width>498</width>
      <widthRatio>0.785488958990536</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel6">
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>25</fontSizeAuto>
      <height>55</height>
      <heightRatio>0.0721784776902887</heightRatio>
      <left>15</left>
      <leftRatio>0.0236593059936909</leftRatio>
      <sizeRatio>0.55</sizeRatio>
      <text>帐号</text>
      <top>88</top>
      <topRatio>0.115485564304462</topRatio>
      <widthRatio>0.157728706624606</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel2">
      <backgroundSkin>skin1000</backgroundSkin>
      <fontColor>FFFFFF</fontColor>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>20</fontSizeAuto>
      <height>63</height>
      <heightRatio>0.0826771653543307</heightRatio>
      <left>5</left>
      <leftRatio>0.00788643533123028</leftRatio>
      <onClick>updateVouchers();</onClick>
      <sizeRatio>0.100638977635783</sizeRatio>
      <text>使用代金券</text>
      <top>172</top>
      <topRatio>0.225721784776903</topRatio>
      <width>626</width>
      <widthRatio>0.987381703470032</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel7">
      <backgroundSkin>skin1000</backgroundSkin>
      <fontColor>FFFFFF</fontColor>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>20</fontSizeAuto>
      <height>63</height>
      <heightRatio>0.0826771653543307</heightRatio>
      <left>3</left>
      <leftRatio>0.00473186119873817</leftRatio>
      <onClick>getVouchers();</onClick>
      <sizeRatio>0.100638977635783</sizeRatio>
      <text>查询(无需填写帐号)</text>
      <top>265</top>
      <topRatio>0.347769028871391</topRatio>
      <width>626</width>
      <widthRatio>0.987381703470032</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3">
      <backgroundSkin>line1000</backgroundSkin>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>25</fontSizeAuto>
      <hAlign>left</hAlign>
      <height>399</height>
      <heightRatio>0.523622047244094</heightRatio>
      <layerName>代金券详情</layerName>
      <layerVisible>false</layerVisible>
      <left>2</left>
      <leftRatio>0.00315457413249211</leftRatio>
      <sizeRatio>0.6384</sizeRatio>
      <text>.</text>
      <top>357</top>
      <topRatio>0.468503937007874</topRatio>
      <vAlign>top</vAlign>
      <width>625</width>
      <widthRatio>0.985804416403785</widthRatio>
    </control>
    <control type="Panel" pathname="/divRoot/panel1/panel3/panel4">
      <backgroundSkin>skin1000</backgroundSkin>
      <fontColor>FFFFFF</fontColor>
      <fontFamily>黑体</fontFamily>
      <fontSizeAuto>25</fontSizeAuto>
      <height>50</height>
      <heightRatio>0.12531328320802</heightRatio>
      <left>438</left>
      <leftRatio>0.7008</leftRatio>
      <onClick>ee.setVisible(ee.getControl("panel3"),false);</onClick>
      <sizeRatio>0.284090909090909</sizeRatio>
      <text>取消</text>
      <top>339</top>
      <topRatio>0.849624060150376</topRatio>
      <width>176</width>
      <widthRatio>0.2816</widthRatio>
    </control>
  </controls>
  <taskSet count="2">
    <taskSetItem name="getVouchers">
      <script1><![CDATA[var result=ee.getEditText(ee.getControl("edit1"));
result = result.replace(/\s+/g,""); 
if(result.length<=0){
    alert("请输入代金券号码");
    return;
}
eio.appendString8(result);
   
//eio.appendString8(eb.getCookie("pjToken"));
]]></script1>
      <script2><![CDATA[var serialNumber = eio.readString8();
//var token = eio.readString8();
var sql,sqlResult;   

/*sql = "exec getUserInfoBySession '" + db.encode(token) + "'";
sqlResult = db.executeQuery("PJ", sql); 
es.logWarning(sql);
if (sqlResult == null) {
    eio.appendString8("F");
    es.logWarning("数据库执行错误, sql=" + sql);
    return;
}
db.read(sqlResult);
if (db.getString(sqlResult, "sessionId").length < 5) {
    eio.appendString8("F");
    eio.appendString8("token失效");
    es.logWarning("用户token失效, sql=" + sql);
    return;
} 
var userId = db.getString(sqlResult, "id"); */

/*sql = "exec getCashTicket '" + db.encode(serialNumber) + "','"+db.encode(userId)+"'";
es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql);  
db.read(sqlResult);
es.logWarning(sql);
var errorCode = db.getInt32(sqlResult, "errorCode");
es.logWarning(errorCode);
if (errorCode!=0) {
    eio.appendString8("F");
    eio.appendString8(db.getString(sqlResult, "errorString"));
    return;
}*/
sql="select count(*) as c from cashTicket where serialNumber='"+db.encode(serialNumber)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
es.logWarning(sql);
db.read(sqlResult);
var count=db.getInt32(sqlResult,"c");
if(count<1){
   eio.appendString8("F"); 
   eio.appendString8("代金券错误");
   return;
}

/*sql="select count(*) as c from cashTicket where userId='"+db.encode(userId)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
es.logWarning(sql);
db.read(sqlResult);
var count=db.getInt32(sqlResult,"c");
if(count>0){
   eio.appendString8("F"); 
   eio.appendString8("您已使用过代金卷");
   return;
}*/

sql="select * from cashTicket where serialNumber='"+db.encode(serialNumber)+"'" 
sqlResult = db.executeQuery("PJ", sql);  
es.logWarning(sql);
db.read(sqlResult);
var displayName = db.getString(sqlResult, "displayName");
var pay = db.getString(sqlResult, "pay");
var payFree = db.getString(sqlResult, "payFree");
var regDatetime = db.getString(sqlResult, "regDatetime");
var used = db.getString(sqlResult, "used");
var userId=db.getString(sqlResult, "userId"); 
var idName="无"; 
var nickName="无"
if(used=="T"){
   used="已使用" ;
}  
else {
   used="未使用" ;
}   
if(userId==0){
   userId="无";
}    
else {
   sql="select * from userInfo where id='"+db.encode(userId)+"'"; 
   sqlResult = db.executeQuery("PJ", sql);
   db.read(sqlResult);
   idName=db.getString(sqlResult, "idName"); 
   if(idName.length<=0){
       idName="无";
   } 
   nickName=db.getString(sqlResult, "nickName"); 
   if(nickName.length<=0){
       nickName="无";
   }
}

eio.appendString8("T"); 
eio.appendString8(displayName);
eio.appendString8(pay);
eio.appendString8(payFree);
eio.appendString8(regDatetime);
eio.appendString8(used);   
eio.appendString8(userId);  
eio.appendString8(idName);
eio.appendString8(nickName);

]]></script2>
      <script3><![CDATA[var result = eio.readString8();   
if (result=="F") {
    alert("代金券使用失败：" + eio.readString8());
    return;
} 
var displayName =eio.readString8();
var pay =eio.readString8();
var payFree =eio.readString8();
var regDatetime =eio.readString8();
var used =eio.readString8();  
var userId =eio.readString8(); 
var idName =eio.readString8(); 
var nickName =eio.readString8();
/*if(used=="T"){
    alert("该代金券已过期或已被使用");
    return;
} 
else {
    used="可使用";
}*/
var text="代金券名称："+displayName+"<br />包含金额："+pay.substring(0,pay.indexOf(".") + 3)+"<br />包含赠送金额："+payFree.substring(0,payFree.indexOf(".") + 3)+"<br />发行时间："+regDatetime+"<br />使用状态："+used+"<br />已使用用户id："+userId+"<br />已使用用户身份证姓名："+idName+"<br />已使用用户昵称："+nickName;
ee.setText(ee.getControl("panel3"),text); 
ee.setVisible(ee.getControl("panel3"),true);
]]></script3>
    </taskSetItem>
    <taskSetItem name="updateVouchers">
      <script1><![CDATA[var result=ee.getEditText(ee.getControl("edit1"));
result = result.replace(/\s+/g,"");
eio.appendString8(result);   
var mobile=ee.getEditText(ee.getControl("edit2"));
if(result.length<=0){
    alert("请输入代金券号码");
    return;
}
if(mobile.length<=0){
    alert("请输入需要使用代金券的帐号");
    return;
}
eio.appendString8(mobile);
]]></script1>
      <script2><![CDATA[var serialNumber = eio.readString8();
var mobile = eio.readString8();  
var date = new Date();
var seperator1 = "-";
var seperator2 = ":";
var month = date.getMonth() + 1;
var strDate = date.getDate();
if (month >= 1 &amp;&amp; month <= 9) {
    month = "0" + month;
}
if (strDate >= 0 &amp;&amp; strDate <= 9) {
    strDate = "0" + strDate;
}
var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate+ " " + date.getHours() + seperator2 + date.getMinutes()+ seperator2 + date.getSeconds(); 
var sql,sqlResult; 
/*sql = "exec getUserInfoBySession '" + db.encode(token) + "'";
sqlResult = db.executeQuery("PJ", sql);
if (sqlResult == null) {
    eio.appendString8("F");
    es.logWarning("数据库执行错误, sql=" + sql);
    return;
}
db.read(sqlResult);
if (db.getString(sqlResult, "sessionId").length < 5) {
    eio.appendString8("F");
    eio.appendString8("token失效");
    es.logWarning("用户token失效, sql=" + sql);
    return;
} 
var userId = db.getString(sqlResult, "id");*/  
sql="select count(*) as c from userInfo where mobile='"+db.encode(mobile)+"'";
sqlResult = db.executeQuery("PJ", sql);  
db.read(sqlResult);
var countId=db.getInt32(sqlResult,"c");
if(countId<=0){
   eio.appendString8("F");
   eio.appendString8("用户不存在");
   return; 
}

sql="select * from userInfo where mobile='"+db.encode(mobile)+"'";
sqlResult = db.executeQuery("PJ", sql);  
db.read(sqlResult);
var userId=db.getString(sqlResult,"id");

sql = "exec getCashTicket '" + db.encode(serialNumber) + "','"+db.encode(userId)+"'";
es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql);  
db.read(sqlResult);
es.logWarning(sql);
var errorCode = db.getInt32(sqlResult, "errorCode");
es.logWarning(errorCode);
if (errorCode!=0) {
    eio.appendString8("F");
    eio.appendString8(db.getString(sqlResult, "errorString"));
    return;
}

sql="update cashTicket set  useDatetime='"+db.encode(currentdate)+"',used='T',userId='"+db.encode(userId)+"' where serialNumber='"+db.encode(serialNumber)+"'" 
es.logWarning(sql);
sqlResult = db.executeQuery("PJ", sql); 
es.logWarning(sql);
db.read(sqlResult);
eio.appendString8("T");
]]></script2>
      <script3>var result =eio.readString8();
if(result=="F"){
    alert("错误信息："+eio.readString8());
    return;
}
alert("代金券使用成功！");  
//ee.setVisible(ee.getControl("panel43"), false);
</script3>
    </taskSetItem>
  </taskSet>
  <gridLines count="0" />
</page>